{"version":3,"sources":["../../src/handler/handler_inertia.ts"],"names":["defaultInertiaOptions","linearity","easing","defaultPanInertiaOptions","deceleration","maxSpeed","defaultZoomInertiaOptions","defaultBearingInertiaOptions","defaultPitchInertiaOptions","HandlerInertia","map","inertiaBuffer","clear","settings","drainInertiaBuffer","push","time","inertia","nowTime","cutoff","length","shift","panInertiaOptions","deltas","zoom","bearing","pitch","pan","Point","pinchAround","undefined","around","zoomDelta","bearingDelta","pitchDelta","panDelta","_add","lastEntry","duration","easeOptions","mag","result","calculateEasing","offset","mult","amount","center","transform","extendDuration","last","unproject","getCenter","noMoveStart","inertiaDuration","inertiaOptions","speed","Math","abs"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport Point from '../geo/point';\n\n// tslint:disable-next-line:no-submodule-imports\nimport merge from 'lodash/merge';\nimport { Map } from '../map';\nimport { bezier, clamp, now } from '../util';\nimport { IDragPanOptions } from './shim/drag_pan';\n\nconst defaultInertiaOptions = {\n  linearity: 0.3,\n  easing: bezier(0, 0, 0.3, 1),\n};\n\nconst defaultPanInertiaOptions = merge(\n  {\n    deceleration: 2500,\n    maxSpeed: 1400,\n  },\n  defaultInertiaOptions,\n);\n\nconst defaultZoomInertiaOptions = merge(\n  {\n    deceleration: 20,\n    maxSpeed: 1400,\n  },\n  defaultInertiaOptions,\n);\n\nconst defaultBearingInertiaOptions = merge(\n  {\n    deceleration: 1000,\n    maxSpeed: 360,\n  },\n  defaultInertiaOptions,\n);\n\nconst defaultPitchInertiaOptions = merge(\n  {\n    deceleration: 1000,\n    maxSpeed: 90,\n  },\n  defaultInertiaOptions,\n);\n\nexport interface IInertiaOptions {\n  linearity: number;\n  easing: (t: number) => number;\n  deceleration: number;\n  maxSpeed: number;\n}\n\nexport type InputEvent = MouseEvent | TouchEvent | KeyboardEvent | WheelEvent;\n\nexport default class HandlerInertia {\n  private map: Map;\n  private inertiaBuffer: Array<{\n    time: number;\n    settings: { [key: string]: any };\n  }>;\n\n  constructor(map: Map) {\n    this.map = map;\n    this.clear();\n  }\n\n  public clear() {\n    this.inertiaBuffer = [];\n  }\n\n  public record(settings: any) {\n    this.drainInertiaBuffer();\n    this.inertiaBuffer.push({ time: now(), settings });\n  }\n\n  public drainInertiaBuffer() {\n    const inertia = this.inertiaBuffer;\n    const nowTime = now();\n    const cutoff = 160; // msec\n\n    while (inertia.length > 0 && nowTime - inertia[0].time > cutoff) {\n      inertia.shift();\n    }\n  }\n\n  public onMoveEnd(panInertiaOptions?: IDragPanOptions) {\n    this.drainInertiaBuffer();\n    if (this.inertiaBuffer.length < 2) {\n      return;\n    }\n\n    const deltas = {\n      zoom: 0,\n      bearing: 0,\n      pitch: 0,\n      pan: new Point(0, 0),\n      pinchAround: undefined,\n      around: undefined,\n    };\n\n    for (const { settings } of this.inertiaBuffer) {\n      deltas.zoom += settings.zoomDelta || 0;\n      deltas.bearing += settings.bearingDelta || 0;\n      deltas.pitch += settings.pitchDelta || 0;\n      if (settings.panDelta) {\n        deltas.pan._add(settings.panDelta);\n      }\n      if (settings.around) {\n        deltas.around = settings.around;\n      }\n      if (settings.pinchAround) {\n        deltas.pinchAround = settings.pinchAround;\n      }\n    }\n\n    const lastEntry = this.inertiaBuffer[this.inertiaBuffer.length - 1];\n    const duration = lastEntry.time - this.inertiaBuffer[0].time;\n\n    const easeOptions: { [key: string]: any } = {};\n\n    if (deltas.pan.mag()) {\n      const result = calculateEasing(\n        deltas.pan.mag(),\n        duration,\n        merge({}, defaultPanInertiaOptions, panInertiaOptions || {}),\n      );\n      easeOptions.offset = deltas.pan.mult(result.amount / deltas.pan.mag());\n      easeOptions.center = this.map.transform.center;\n      extendDuration(easeOptions, result);\n    }\n\n    if (deltas.zoom) {\n      const result = calculateEasing(\n        deltas.zoom,\n        duration,\n        defaultZoomInertiaOptions,\n      );\n      easeOptions.zoom = this.map.transform.zoom + result.amount;\n      extendDuration(easeOptions, result);\n    }\n\n    if (deltas.bearing) {\n      const result = calculateEasing(\n        deltas.bearing,\n        duration,\n        defaultBearingInertiaOptions,\n      );\n      easeOptions.bearing =\n        this.map.transform.bearing + clamp(result.amount, -179, 179);\n      extendDuration(easeOptions, result);\n    }\n\n    if (deltas.pitch) {\n      const result = calculateEasing(\n        deltas.pitch,\n        duration,\n        defaultPitchInertiaOptions,\n      );\n      easeOptions.pitch = this.map.transform.pitch + result.amount;\n      extendDuration(easeOptions, result);\n    }\n\n    if (easeOptions.zoom || easeOptions.bearing) {\n      const last =\n        deltas.pinchAround === undefined ? deltas.around : deltas.pinchAround;\n      easeOptions.around = last\n        ? this.map.unproject(last)\n        : this.map.getCenter();\n    }\n\n    this.clear();\n    return merge(easeOptions, {\n      noMoveStart: true,\n    });\n  }\n}\n\n// Unfortunately zoom, bearing, etc can't have different durations and easings so\n// we need to choose one. We use the longest duration and it's corresponding easing.\nfunction extendDuration(easeOptions: any, result: any) {\n  if (!easeOptions.duration || easeOptions.duration < result.duration) {\n    easeOptions.duration = result.duration;\n    easeOptions.easing = result.easing;\n  }\n}\n\nfunction calculateEasing(\n  amount: number,\n  inertiaDuration: number,\n  inertiaOptions: IInertiaOptions,\n) {\n  const { maxSpeed, linearity, deceleration } = inertiaOptions;\n  const speed = clamp(\n    (amount * linearity) / (inertiaDuration / 1000),\n    -maxSpeed,\n    maxSpeed,\n  );\n  const duration = Math.abs(speed) / (deceleration * linearity);\n  return {\n    easing: inertiaOptions.easing,\n    duration: duration * 1000,\n    amount: speed * (duration / 2),\n  };\n}\n"],"file":"handler_inertia.js"}