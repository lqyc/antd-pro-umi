{"version":3,"sources":["../../src/handler/handler_manager.ts"],"names":["isMoving","p","zoom","drag","pitch","rotate","hasChange","result","panDelta","mag","zoomDelta","bearingDelta","pitchDelta","HandlerManager","map","options","el","handlers","eventsInProgress","frameId","inertia","bearingSnap","handlersById","updatingCamera","changes","previousActiveHandlers","bearingChanged","listeners","handleWindowEvent","e","handleEvent","type","eventName","stop","inputEvent","undefined","mergedIHandlerResult","needsRenderFrame","activeHandlers","mapTouches","touches","getMapTouches","points","DOM","touchPos","mousePos","handlerName","handler","allowed","isEnabled","data","blockedByActive","reset","handerName","mergeIHandlerResult","triggerRenderFrame","isActive","deactivatedHandlers","name","Object","keys","length","push","cameraAnimation","clear","fireEvents","getCanvasContainer","HandlerInertia","addDefaultHandlers","passive","window","document","capture","target","listenerOptions","addEventListener","removeEventListener","scrollZoom","isZooming","Boolean","HandlerResult","eventData","originalEvent","requestRenderFrame","timeStamp","RenderFrameEvent","applyChanges","add","MapEventHandler","boxZoom","BoxZoomHandler","tapZoom","TapZoomHandler","clickZoom","ClickZoomHandler","doubleClickZoom","DoubleClickZoomHandler","tapDragZoom","TapDragZoomHandler","touchPitch","TouchPitchHandler","mouseRotate","MouseRotateHandler","mousePitch","MousePitchHandler","dragRotate","DragRotateHandler","mousePan","MousePanHandler","touchPan","TouchPanHandler","dragPan","DragPanHandler","touchRotate","TouchRotateHandler","touchZoom","TouchZoomHandler","touchZoomRotate","TouchZoomRotateHandler","ScrollZoomHandler","keyboard","KeyboardHandler","BlockableMapEventHandler","interactive","enable","myName","indexOf","t","contains","combined","combinedEventsInProgress","combinedDeactivatedHandlers","change","Point","_add","around","pinchAround","noInertia","updateMapTransform","combinedResult","tr","transform","centerPoint","loc","pointLocation","sub","bearing","setLocationAtPoint","update","record","newEventsInProgress","wasMoving","nowMoving","startEvents","fireEvent","endEvents","originalEndEvent","stillMoving","inertialEase","onMoveEnd","inertiaOptions","shouldSnapToNorth","getBearing","easeTo","emit","Event","resetNorth"],"mappings":"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","sourcesContent":["// @ts-ignore\n// tslint:disable-next-line: no-submodule-imports\nimport merge from 'lodash/merge';\nimport Point from '../geo/point';\nimport { Map } from '../map';\nimport DOM from '../utils/dom';\nimport BlockableMapEventHandler from './blockable_map_event';\nimport BoxZoomHandler from './box_zoom';\nimport ClickZoomHandler from './click_zoom';\nimport { Event } from './events/event';\nimport RenderFrameEvent from './events/render_event';\nimport HandlerInertia from './handler_inertia';\nimport { IHandler, IHandlerResult } from './IHandler';\nimport KeyboardHandler from './keyboard';\nimport MapEventHandler from './map_event';\nimport {\n  MousePanHandler,\n  MousePitchHandler,\n  MouseRotateHandler,\n} from './mouse';\nimport ScrollZoomHandler from './scroll_zoom';\nimport DoubleClickZoomHandler from './shim/dblclick_zoom';\nimport DragPanHandler from './shim/drag_pan';\nimport DragRotateHandler from './shim/drag_rotate';\nimport TouchZoomRotateHandler from './shim/touch_zoom_rotate';\nimport TapDragZoomHandler from './tap/tap_drag_zoom';\nimport TapZoomHandler from './tap/tap_zoom';\nimport {\n  TouchPanHandler,\n  TouchPitchHandler,\n  TouchRotateHandler,\n  TouchZoomHandler,\n} from './touch';\n\nexport type InputEvent = MouseEvent | TouchEvent | KeyboardEvent | WheelEvent;\n\nconst isMoving = (p: any) => p.zoom || p.drag || p.pitch || p.rotate;\n\nfunction hasChange(result: IHandlerResult) {\n  return (\n    (result.panDelta && result.panDelta.mag()) ||\n    result.zoomDelta ||\n    result.bearingDelta ||\n    result.pitchDelta\n  );\n}\n\nexport interface IHandlerOptions {\n  interactive: boolean;\n  boxZoom: boolean;\n  dragRotate: boolean;\n  dragPan: boolean;\n  keyboard: boolean;\n  doubleClickZoom: boolean;\n  touchZoomRotate: boolean;\n  touchPitch: boolean;\n  trackResize: boolean;\n  renderWorldCopies: boolean;\n  bearingSnap: number;\n  clickTolerance: number;\n  pitchWithRotate: boolean;\n}\n\nclass HandlerManager {\n  private map: Map;\n  private el: HTMLElement;\n  private handlers: Array<{\n    handlerName: string;\n    handler: IHandler;\n    allowed: any;\n  }>;\n  private eventsInProgress: any;\n  private frameId: number;\n  private inertia: HandlerInertia;\n  private bearingSnap: number;\n  private handlersById: { [key: string]: IHandler };\n  private updatingCamera: boolean;\n  private changes: Array<[IHandlerResult, any, any]>;\n  private previousActiveHandlers: { [key: string]: IHandler };\n  private bearingChanged: boolean;\n  private listeners: Array<\n    [HTMLElement, string, void | { passive?: boolean; capture?: boolean }]\n  >;\n\n  constructor(map: Map, options: IHandlerOptions) {\n    this.map = map;\n    this.el = this.map.getCanvasContainer();\n    this.handlers = [];\n    this.handlersById = {};\n    this.changes = [];\n\n    this.inertia = new HandlerInertia(map);\n    this.bearingSnap = options.bearingSnap;\n    this.previousActiveHandlers = {};\n\n    // Track whether map is currently moving, to compute start/move/end events\n    this.eventsInProgress = {};\n\n    this.addDefaultHandlers(options);\n\n    const el = this.el;\n\n    this.listeners = [\n      // Bind touchstart and touchmove with passive: false because, even though\n      // they only fire a map events and therefore could theoretically be\n      // passive, binding with passive: true causes iOS not to respect\n      // e.preventDefault() in _other_ handlers, even if they are non-passive\n      // (see https://bugs.webkit.org/show_bug.cgi?id=184251)\n      [el, 'touchstart', { passive: false }],\n      [el, 'touchmove', { passive: false }],\n      [el, 'touchend', undefined],\n      [el, 'touchcancel', undefined],\n\n      [el, 'mousedown', undefined],\n      [el, 'mousemove', undefined],\n      [el, 'mouseup', undefined],\n\n      // Bind window-level event listeners for move and up/end events. In the absence of\n      // the pointer capture API, which is not supported by all necessary platforms,\n      // window-level event listeners give us the best shot at capturing events that\n      // fall outside the map canvas element. Use `{capture: true}` for the move event\n      // to prevent map move events from being fired during a drag.\n      // @ts-ignore\n      [window.document, 'mousemove', { capture: true }],\n      // @ts-ignore\n      [window.document, 'mouseup', undefined],\n\n      [el, 'mouseover', undefined],\n      [el, 'mouseout', undefined],\n      [el, 'dblclick', undefined],\n      [el, 'click', undefined],\n\n      [el, 'keydown', { capture: false }],\n      [el, 'keyup', undefined],\n\n      [el, 'wheel', { passive: false }],\n      [el, 'contextmenu', undefined],\n      // @ts-ignore\n      [window, 'blur', undefined],\n    ];\n    for (const [target, type, listenerOptions] of this.listeners) {\n      // @ts-ignore\n      DOM.addEventListener(\n        target,\n        type,\n        // @ts-ignore\n        target === window.document ? this.handleWindowEvent : this.handleEvent,\n        listenerOptions,\n      );\n    }\n  }\n  public destroy() {\n    for (const [target, type, listenerOptions] of this.listeners) {\n      // @ts-ignore\n      DOM.removeEventListener(\n        target,\n        type,\n        // @ts-ignore\n        target === window.document ? this.handleWindowEvent : this.handleEvent,\n        listenerOptions,\n      );\n    }\n  }\n\n  public stop() {\n    // do nothing if this method was triggered by a gesture update\n    if (this.updatingCamera) {\n      return;\n    }\n\n    for (const { handler } of this.handlers) {\n      handler.reset();\n    }\n    this.inertia.clear();\n    this.fireEvents({}, {});\n    this.changes = [];\n  }\n\n  public isActive() {\n    for (const { handler } of this.handlers) {\n      if (handler.isActive()) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  public isZooming() {\n    return !!this.eventsInProgress.zoom || this.map.scrollZoom.isZooming();\n  }\n  public isRotating() {\n    return !!this.eventsInProgress.rotate;\n  }\n\n  public isMoving() {\n    return Boolean(isMoving(this.eventsInProgress)) || this.isZooming();\n  }\n\n  public handleWindowEvent = (e: InputEvent) => {\n    this.handleEvent(e, `${e.type}Window`);\n  };\n\n  public handleEvent = (\n    e: InputEvent | RenderFrameEvent,\n    eventName?: string,\n  ) => {\n    if (e.type === 'blur') {\n      this.stop();\n      return;\n    }\n    this.updatingCamera = true;\n    const inputEvent = e.type === 'renderFrame' ? undefined : (e as InputEvent);\n\n    /*\n     * We don't call e.preventDefault() for any events by default.\n     * Handlers are responsible for calling it where necessary.\n     */\n\n    const mergedIHandlerResult: IHandlerResult = { needsRenderFrame: false };\n    const eventsInProgress: { [key: string]: any } = {};\n    const activeHandlers: { [key: string]: any } = {};\n    // @ts-ignore\n    const mapTouches = e.touches\n      ? // @ts-ignore\n        this.getMapTouches(e.touches as Touch[])\n      : undefined;\n    const points = mapTouches\n      ? DOM.touchPos(this.el, mapTouches)\n      : DOM.mousePos(this.el, e as MouseEvent);\n\n    for (const { handlerName, handler, allowed } of this.handlers) {\n      if (!handler.isEnabled()) {\n        continue;\n      }\n      let data: IHandlerResult;\n      if (this.blockedByActive(activeHandlers, allowed, handlerName)) {\n        handler.reset();\n      } else {\n        const handerName = eventName || e.type;\n        // @ts-ignore\n        if (handler && handler[handerName]) {\n          // @ts-ignore\n          data = handler[handerName](e, points, mapTouches);\n          this.mergeIHandlerResult(\n            mergedIHandlerResult,\n            eventsInProgress,\n            data,\n            handlerName,\n            inputEvent,\n          );\n          if (data && data.needsRenderFrame) {\n            this.triggerRenderFrame();\n          }\n        }\n      }\n      // @ts-ignore\n      if (data || handler.isActive()) {\n        activeHandlers[handlerName] = handler;\n      }\n    }\n\n    const deactivatedHandlers: { [key: string]: any } = {};\n    for (const name in this.previousActiveHandlers) {\n      if (!activeHandlers[name]) {\n        deactivatedHandlers[name] = inputEvent;\n      }\n    }\n    this.previousActiveHandlers = activeHandlers;\n    if (\n      Object.keys(deactivatedHandlers).length ||\n      hasChange(mergedIHandlerResult)\n    ) {\n      this.changes.push([\n        mergedIHandlerResult,\n        eventsInProgress,\n        deactivatedHandlers,\n      ]);\n      this.triggerRenderFrame();\n    }\n\n    if (Object.keys(activeHandlers).length || hasChange(mergedIHandlerResult)) {\n      this.map.stop(true);\n    }\n\n    this.updatingCamera = false;\n\n    const { cameraAnimation } = mergedIHandlerResult;\n    if (cameraAnimation) {\n      this.inertia.clear();\n      this.fireEvents({}, {});\n      this.changes = [];\n      cameraAnimation(this.map);\n    }\n  };\n\n  public mergeIHandlerResult(\n    mergedIHandlerResult: IHandlerResult,\n    eventsInProgress: { [key: string]: any },\n    HandlerResult: IHandlerResult,\n    name: string,\n    e?: InputEvent,\n  ) {\n    if (!HandlerResult) {\n      return;\n    }\n\n    merge(mergedIHandlerResult, HandlerResult);\n\n    const eventData = {\n      handlerName: name,\n      originalEvent: HandlerResult.originalEvent || e,\n    };\n\n    // track which handler changed which camera property\n    if (HandlerResult.zoomDelta !== undefined) {\n      eventsInProgress.zoom = eventData;\n    }\n    if (HandlerResult.panDelta !== undefined) {\n      eventsInProgress.drag = eventData;\n    }\n    if (HandlerResult.pitchDelta !== undefined) {\n      eventsInProgress.pitch = eventData;\n    }\n    if (HandlerResult.bearingDelta !== undefined) {\n      eventsInProgress.rotate = eventData;\n    }\n  }\n\n  public triggerRenderFrame() {\n    if (this.frameId === undefined) {\n      this.frameId = this.map.requestRenderFrame((timeStamp: number) => {\n        delete this.frameId;\n        this.handleEvent(new RenderFrameEvent('renderFrame', { timeStamp }));\n        this.applyChanges();\n      });\n    }\n  }\n\n  private addDefaultHandlers(options: IHandlerOptions) {\n    const map = this.map;\n    const el = map.getCanvasContainer();\n    this.add('mapEvent', new MapEventHandler(map, options));\n\n    const boxZoom = (map.boxZoom = new BoxZoomHandler(map, options));\n    this.add('boxZoom', boxZoom);\n\n    const tapZoom = new TapZoomHandler();\n    const clickZoom = new ClickZoomHandler();\n    map.doubleClickZoom = new DoubleClickZoomHandler(clickZoom, tapZoom);\n    this.add('tapZoom', tapZoom);\n    this.add('clickZoom', clickZoom);\n\n    const tapDragZoom = new TapDragZoomHandler();\n    this.add('tapDragZoom', tapDragZoom);\n\n    const touchPitch = (map.touchPitch = new TouchPitchHandler());\n    this.add('touchPitch', touchPitch);\n\n    const mouseRotate = new MouseRotateHandler(options);\n    const mousePitch = new MousePitchHandler(options);\n    map.dragRotate = new DragRotateHandler(options, mouseRotate, mousePitch);\n    this.add('mouseRotate', mouseRotate, ['mousePitch']);\n    this.add('mousePitch', mousePitch, ['mouseRotate']);\n\n    const mousePan = new MousePanHandler(options);\n    const touchPan = new TouchPanHandler(options);\n    map.dragPan = new DragPanHandler(el, mousePan, touchPan);\n    this.add('mousePan', mousePan);\n    this.add('touchPan', touchPan, ['touchZoom', 'touchRotate']);\n\n    const touchRotate = new TouchRotateHandler();\n    const touchZoom = new TouchZoomHandler();\n    map.touchZoomRotate = new TouchZoomRotateHandler(\n      el,\n      touchZoom,\n      touchRotate,\n      tapDragZoom,\n    );\n    this.add('touchRotate', touchRotate, ['touchPan', 'touchZoom']);\n    this.add('touchZoom', touchZoom, ['touchPan', 'touchRotate']);\n\n    const scrollZoom = (map.scrollZoom = new ScrollZoomHandler(map, this));\n    this.add('scrollZoom', scrollZoom, ['mousePan']);\n\n    const keyboard = (map.keyboard = new KeyboardHandler());\n    this.add('keyboard', keyboard);\n\n    this.add('blockableMapEvent', new BlockableMapEventHandler(map));\n\n    for (const name of [\n      'boxZoom',\n      'doubleClickZoom',\n      'tapDragZoom',\n      'touchPitch',\n      'dragRotate',\n      'dragPan',\n      'touchZoomRotate',\n      'scrollZoom',\n      'keyboard',\n    ]) {\n      // @ts-ignore\n      if (options.interactive && options[name]) {\n        // @ts-ignore\n        map[name].enable(options[name]);\n      }\n    }\n  }\n\n  private add(handlerName: string, handler: IHandler, allowed?: string[]) {\n    this.handlers.push({ handlerName, handler, allowed });\n    this.handlersById[handlerName] = handler;\n  }\n\n  private blockedByActive(\n    activeHandlers: { [key: string]: IHandler },\n    allowed: string[],\n    myName: string,\n  ) {\n    for (const name in activeHandlers) {\n      if (name === myName) {\n        continue;\n      }\n      if (!allowed || allowed.indexOf(name) < 0) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private getMapTouches(touches: Touch[]): Touch[] {\n    const mapTouches = [];\n    for (const t of touches) {\n      const target = t.target as Node;\n      if (this.el.contains(target)) {\n        mapTouches.push(t);\n      }\n    }\n    return mapTouches;\n  }\n\n  private applyChanges() {\n    const combined: { [key: string]: any } = {};\n    const combinedEventsInProgress = {};\n    const combinedDeactivatedHandlers = {};\n\n    for (const [change, eventsInProgress, deactivatedHandlers] of this\n      .changes) {\n      if (change.panDelta) {\n        combined.panDelta = (combined.panDelta || new Point(0, 0))._add(\n          change.panDelta,\n        );\n      }\n      if (change.zoomDelta) {\n        combined.zoomDelta = (combined.zoomDelta || 0) + change.zoomDelta;\n      }\n      if (change.bearingDelta) {\n        combined.bearingDelta =\n          (combined.bearingDelta || 0) + change.bearingDelta;\n      }\n      if (change.pitchDelta) {\n        combined.pitchDelta = (combined.pitchDelta || 0) + change.pitchDelta;\n      }\n      if (change.around !== undefined) {\n        combined.around = change.around;\n      }\n      if (change.pinchAround !== undefined) {\n        combined.pinchAround = change.pinchAround;\n      }\n      if (change.noInertia) {\n        combined.noInertia = change.noInertia;\n      }\n\n      merge(combinedEventsInProgress, eventsInProgress);\n      merge(combinedDeactivatedHandlers, deactivatedHandlers);\n    }\n\n    this.updateMapTransform(\n      combined,\n      combinedEventsInProgress,\n      combinedDeactivatedHandlers,\n    );\n    this.changes = [];\n  }\n\n  private updateMapTransform(\n    combinedResult: any,\n    combinedEventsInProgress: any,\n    deactivatedHandlers: any,\n  ) {\n    const map = this.map;\n    const tr = map.transform;\n\n    if (!hasChange(combinedResult)) {\n      return this.fireEvents(combinedEventsInProgress, deactivatedHandlers);\n    }\n    const {\n      panDelta,\n      zoomDelta,\n      bearingDelta,\n      pitchDelta,\n      pinchAround,\n    } = combinedResult;\n    let { around } = combinedResult;\n\n    if (pinchAround !== undefined) {\n      around = pinchAround;\n    }\n\n    // stop any ongoing camera animations (easeTo, flyTo)\n    map.stop(true);\n\n    around = around || map.transform.centerPoint;\n    const loc = tr.pointLocation(panDelta ? around.sub(panDelta) : around);\n    if (bearingDelta) {\n      tr.bearing += bearingDelta;\n    }\n    if (pitchDelta) {\n      tr.pitch += pitchDelta;\n    }\n    if (zoomDelta) {\n      tr.zoom += zoomDelta;\n    }\n    tr.setLocationAtPoint(loc, around);\n\n    this.map.update();\n    if (!combinedResult.noInertia) {\n      this.inertia.record(combinedResult);\n    }\n    this.fireEvents(combinedEventsInProgress, deactivatedHandlers);\n  }\n\n  private fireEvents(\n    newEventsInProgress: { [key: string]: any },\n    deactivatedHandlers: { [key: string]: any },\n  ) {\n    const wasMoving = isMoving(this.eventsInProgress);\n    const nowMoving = isMoving(newEventsInProgress);\n\n    const startEvents: { [key: string]: any } = {};\n\n    for (const eventName in newEventsInProgress) {\n      if (newEventsInProgress[eventName]) {\n        const { originalEvent } = newEventsInProgress[eventName];\n        if (!this.eventsInProgress[eventName]) {\n          startEvents[`${eventName}start`] = originalEvent;\n        }\n\n        this.eventsInProgress[eventName] = newEventsInProgress[eventName];\n      }\n    }\n\n    // fire start events only after this.eventsInProgress has been updated\n    if (!wasMoving && nowMoving) {\n      this.fireEvent('movestart', nowMoving.originalEvent);\n    }\n\n    for (const name in startEvents) {\n      if (startEvents[name]) {\n        this.fireEvent(name, startEvents[name]);\n      }\n    }\n\n    if (newEventsInProgress.rotate) {\n      this.bearingChanged = true;\n    }\n\n    if (nowMoving) {\n      this.fireEvent('move', nowMoving.originalEvent);\n    }\n\n    for (const eventName in newEventsInProgress) {\n      if (newEventsInProgress[eventName]) {\n        const { originalEvent } = newEventsInProgress[eventName];\n        this.fireEvent(eventName, originalEvent);\n      }\n    }\n\n    const endEvents: { [key: string]: any } = {};\n\n    let originalEndEvent;\n    for (const eventName in this.eventsInProgress) {\n      if (this.eventsInProgress[eventName]) {\n        const { handlerName, originalEvent } = this.eventsInProgress[eventName];\n        if (!this.handlersById[handlerName].isActive()) {\n          delete this.eventsInProgress[eventName];\n          originalEndEvent = deactivatedHandlers[handlerName] || originalEvent;\n          endEvents[`${eventName}end`] = originalEndEvent;\n        }\n      }\n    }\n\n    for (const name in endEvents) {\n      if (endEvents[name]) {\n        this.fireEvent(name, endEvents[name]);\n      }\n    }\n\n    const stillMoving = isMoving(this.eventsInProgress);\n    if ((wasMoving || nowMoving) && !stillMoving) {\n      this.updatingCamera = true;\n      const inertialEase = this.inertia.onMoveEnd(\n        this.map.dragPan.inertiaOptions,\n      );\n\n      const shouldSnapToNorth = (bearing: number) =>\n        bearing !== 0 &&\n        -this.bearingSnap < bearing &&\n        bearing < this.bearingSnap;\n\n      if (inertialEase) {\n        if (shouldSnapToNorth(inertialEase.bearing || this.map.getBearing())) {\n          inertialEase.bearing = 0;\n        }\n        this.map.easeTo(inertialEase, { originalEvent: originalEndEvent });\n      } else {\n        this.map.emit(\n          'moveend',\n          new Event('moveend', { originalEvent: originalEndEvent }),\n        );\n        if (shouldSnapToNorth(this.map.getBearing())) {\n          this.map.resetNorth();\n        }\n      }\n      this.bearingChanged = false;\n      this.updatingCamera = false;\n    }\n  }\n\n  private fireEvent(type: string, e: any) {\n    this.map.emit(type, new Event(type, e ? { originalEvent: e } : {}));\n  }\n}\n\nexport default HandlerManager;\n"],"file":"handler_manager.js"}