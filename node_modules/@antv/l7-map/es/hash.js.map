{"version":3,"sources":["../src/hash.ts"],"names":["throttle","Hash","hashName","map","updateHash","onHashChange","loc","getCurrentHash","length","some","v","isNaN","bearing","dragRotate","isEnabled","touchZoomRotate","getBearing","jumpTo","center","zoom","pitch","hash","window","location","replace","keyval","split","part","forEach","updateHashUnthrottled","getHashString","history","replaceState","state","SecurityError","encodeURIComponent","addEventListener","on","removeEventListener","off","mapFeedback","getCenter","Math","round","getZoom","precision","ceil","LN2","log","LN10","m","pow","lng","lat","getPitch","found","parts","slice","key","filter","a","push","join"],"mappings":"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","sourcesContent":["// @ts-ignore\n// tslint:disable-next-line:no-submodule-imports\nimport throttle from 'lodash/throttle';\nimport { Map } from './map';\n\n/*\n * Adds the map's position to its page's location hash.\n * Passed as an option to the map object.\n *\n * @returns {Hash} `this`\n */\nclass Hash {\n  private map: Map;\n  private updateHash: () => number | void;\n  private hashName?: string;\n\n  constructor(hashName?: string) {\n    this.hashName = hashName && encodeURIComponent(hashName);\n\n    // Mobile Safari doesn't allow updating the hash more than 100 times per 30 seconds.\n    this.updateHash = throttle(this.updateHashUnthrottled, (30 * 1000) / 100);\n  }\n  public addTo(map: Map) {\n    this.map = map;\n    window.addEventListener('hashchange', this.onHashChange, false);\n    this.map.on('moveend', this.updateHash);\n    return this;\n  }\n  public remove() {\n    window.removeEventListener('hashchange', this.onHashChange, false);\n    this.map.off('moveend', this.updateHash);\n    // clearTimeout(this.updateHash());\n\n    delete this.map;\n    return this;\n  }\n\n  public onHashChange = () => {\n    const loc = this.getCurrentHash();\n    if (loc.length >= 3 && !loc.some((v: string) => isNaN(+v))) {\n      const bearing =\n        this.map.dragRotate.isEnabled() && this.map.touchZoomRotate.isEnabled()\n          ? +(loc[3] || 0)\n          : this.map.getBearing();\n      this.map.jumpTo({\n        center: [+loc[2], +loc[1]],\n        zoom: +loc[0],\n        bearing,\n        pitch: +(loc[4] || 0),\n      });\n      return true;\n    }\n    return false;\n  };\n\n  private getCurrentHash = () => {\n    // Get the current hash from location, stripped from its number sign\n    const hash = window.location.hash.replace('#', '');\n    if (this.hashName) {\n      // Split the parameter-styled hash into parts and find the value we need\n      let keyval;\n      hash\n        .split('&')\n        .map((part) => part.split('='))\n        .forEach((part) => {\n          if (part[0] === this.hashName) {\n            keyval = part;\n          }\n        });\n      return (keyval ? keyval[1] || '' : '').split('/');\n    }\n    return hash.split('/');\n  };\n\n  private getHashString(mapFeedback?: boolean) {\n    const center = this.map.getCenter();\n    const zoom = Math.round(this.map.getZoom() * 100) / 100;\n    // derived from equation: 512px * 2^z / 360 / 10^d < 0.5px\n    const precision = Math.ceil(\n      (zoom * Math.LN2 + Math.log(512 / 360 / 0.5)) / Math.LN10,\n    );\n    const m = Math.pow(10, precision);\n    const lng = Math.round(center.lng * m) / m;\n    const lat = Math.round(center.lat * m) / m;\n    const bearing = this.map.getBearing();\n    const pitch = this.map.getPitch();\n    let hash = '';\n    if (mapFeedback) {\n      // new map feedback site has some constraints that don't allow\n      // us to use the same hash format as we do for the Map hash option.\n      hash += `/${lng}/${lat}/${zoom}`;\n    } else {\n      hash += `${zoom}/${lat}/${lng}`;\n    }\n\n    if (bearing || pitch) {\n      hash += `/${Math.round(bearing * 10) / 10}`;\n    }\n    if (pitch) {\n      hash += `/${Math.round(pitch)}`;\n    }\n\n    if (this.hashName) {\n      const hashName = this.hashName;\n      let found = false;\n      const parts = window.location.hash\n        .slice(1)\n        .split('&')\n        .map((part) => {\n          const key = part.split('=')[0];\n          if (key === hashName) {\n            found = true;\n            return `${key}=${hash}`;\n          }\n          return part;\n        })\n        .filter((a) => a);\n      if (!found) {\n        parts.push(`${hashName}=${hash}`);\n      }\n      return `#${parts.join('&')}`;\n    }\n\n    return `#${hash}`;\n  }\n\n  private updateHashUnthrottled = () => {\n    const hash = this.getHashString();\n    try {\n      window.history.replaceState(window.history.state, '', hash);\n    } catch (SecurityError) {\n      // IE11 does not allow this if the page is within an iframe created\n      // with iframe.contentWindow.document.write(...).\n      // https://github.com/mapbox/mapbox-gl-js/issues/7410\n    }\n  };\n}\n\nexport default Hash;\n"],"file":"hash.js"}