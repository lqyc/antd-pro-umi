{"version":3,"sources":["../../../src/services/shader/ShaderModuleService.ts"],"names":["precisionRegExp","globalDefaultprecision","includeRegExp","ShaderModuleService","moduleCache","rawContentCache","destroy","registerModule","vs","common","fs","decode","projection","project","sdf2d","lighting","light","pickingVert","pickingFrag","moduleName","moduleParams","declaredUniforms","uniforms","extractedVS","content","vsUniforms","extractedFS","fsUniforms","rawVS","rawFS","processModule","vsIncludeList","includeList","fsIncludeList","compiledFs","concat","reduce","prev","cur","test","trim","rawContent","type","compiled","replace","_","strMatch","includeOpt","split","includeName","indexOf","txt","push"],"mappings":"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","sourcesContent":["import { inject, injectable } from 'inversify';\nimport { uniq } from 'lodash';\nimport { extractUniforms } from '../../utils/shader-module';\nimport { IModuleParams, IShaderModuleService } from './IShaderModuleService';\n\nimport common from '../../shaders/common.glsl';\nimport decode from '../../shaders/decode.glsl';\nimport light from '../../shaders/light2.glsl';\nimport lighting from '../../shaders/lighting.glsl';\nimport pickingFrag from '../../shaders/picking.frag.glsl';\nimport pickingVert from '../../shaders/picking.vert.glsl';\nimport project from '../../shaders/project.glsl';\nimport projection from '../../shaders/projection.glsl';\nimport sdf2d from '../../shaders/sdf_2d.glsl';\n\nconst precisionRegExp = /precision\\s+(high|low|medium)p\\s+float/;\nconst globalDefaultprecision =\n  '#ifdef GL_FRAGMENT_PRECISION_HIGH\\n precision highp float;\\n #else\\n precision mediump float;\\n#endif\\n';\nconst includeRegExp = /#pragma include ([\"^+\"]?[\"\\ \"[a-zA-Z_0-9](.*)\"]*?)/g;\n\n@injectable()\nexport default class ShaderModuleService implements IShaderModuleService {\n  private moduleCache: { [key: string]: IModuleParams } = {};\n  private rawContentCache: { [key: string]: IModuleParams } = {};\n\n  public registerBuiltinModules() {\n    this.destroy();\n    this.registerModule('common', { vs: common, fs: common });\n    this.registerModule('decode', { vs: decode, fs: '' });\n    this.registerModule('projection', { vs: projection, fs: '' });\n    this.registerModule('project', { vs: project, fs: '' });\n    this.registerModule('sdf_2d', { vs: '', fs: sdf2d });\n    this.registerModule('lighting', { vs: lighting, fs: '' });\n    this.registerModule('light', { vs: light, fs: '' });\n    this.registerModule('picking', { vs: pickingVert, fs: pickingFrag });\n  }\n\n  public registerModule(moduleName: string, moduleParams: IModuleParams) {\n    // prevent registering the same module multiple times\n    if (this.rawContentCache[moduleName]) {\n      return;\n    }\n\n    const { vs, fs, uniforms: declaredUniforms } = moduleParams;\n    const { content: extractedVS, uniforms: vsUniforms } = extractUniforms(vs);\n    const { content: extractedFS, uniforms: fsUniforms } = extractUniforms(fs);\n\n    this.rawContentCache[moduleName] = {\n      fs: extractedFS,\n      uniforms: {\n        ...vsUniforms,\n        ...fsUniforms,\n        ...declaredUniforms,\n      },\n      vs: extractedVS,\n    };\n  }\n  public destroy() {\n    this.moduleCache = {};\n    this.rawContentCache = {};\n  }\n  public getModule(moduleName: string): IModuleParams {\n    if (this.moduleCache[moduleName]) {\n      return this.moduleCache[moduleName];\n    }\n\n    const rawVS = this.rawContentCache[moduleName].vs;\n    const rawFS = this.rawContentCache[moduleName].fs;\n\n    const { content: vs, includeList: vsIncludeList } = this.processModule(\n      rawVS,\n      [],\n      'vs',\n    );\n    const { content: fs, includeList: fsIncludeList } = this.processModule(\n      rawFS,\n      [],\n      'fs',\n    );\n    let compiledFs = fs;\n    // TODO: extract uniforms and their default values from GLSL\n    const uniforms: {\n      [key: string]: any;\n    } = uniq(vsIncludeList.concat(fsIncludeList).concat(moduleName)).reduce(\n      (prev, cur: string) => {\n        return {\n          ...prev,\n          ...this.rawContentCache[cur].uniforms,\n        };\n      },\n      {},\n    );\n\n    /**\n     * set default precision for fragment shader\n     * https://stackoverflow.com/questions/28540290/why-it-is-necessary-to-set-precision-for-the-fragment-shader\n     */\n    if (!precisionRegExp.test(fs)) {\n      compiledFs = globalDefaultprecision + fs;\n    }\n\n    this.moduleCache[moduleName] = {\n      fs: compiledFs.trim(),\n      uniforms,\n      vs: vs.trim(),\n    };\n    return this.moduleCache[moduleName];\n  }\n\n  private processModule(\n    rawContent: string,\n    includeList: string[],\n    type: 'vs' | 'fs',\n  ): {\n    content: string;\n    includeList: string[];\n  } {\n    const compiled = rawContent.replace(includeRegExp, (_, strMatch) => {\n      const includeOpt = strMatch.split(' ');\n      const includeName = includeOpt[0].replace(/\"/g, '');\n\n      if (includeList.indexOf(includeName) > -1) {\n        return '';\n      }\n\n      const txt = this.rawContentCache[includeName][type];\n      includeList.push(includeName);\n\n      const { content } = this.processModule(txt, includeList, type);\n      return content;\n    });\n\n    return {\n      content: compiled,\n      includeList,\n    };\n  }\n}\n"],"file":"ShaderModuleService.js"}