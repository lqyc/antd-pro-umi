{"version":3,"sources":["../../../src/services/layer/StyleAttributeService.ts"],"names":["inject","injectable","TYPES","gl","StyleAttribute","sleep","ms","Promise","resolve","setTimeout","bytesPerElementMap","FLOAT","UNSIGNED_BYTE","UNSIGNED_SHORT","StyleAttributeService","IRendererService","attributesAndIndices","attributes","triangulation","featureLayout","sizePerElement","elements","options","attributeToUpdate","getLayerStyleAttribute","name","setProps","push","attributeName","updateOptions","registerStyleAttribute","scale","needRescale","needRemapping","needRegenerateVertices","featureRange","find","attribute","scalers","func","features","startFeatureIdx","endFeatureIdx","descriptor","update","buffer","size","bytesPerElement","type","featuresToUpdate","slice","length","offset","bufferOffsetInBytes","updatedBufferData","map","attributeIdx","featureIdx","vertices","normals","verticesNumForCurrentFeature","featureData","vertexIdx","normal","reduce","prev","cur","vertexAttribute","updateBuffer","data","descriptors","attr","resetDescriptor","verticesNum","indices","forEach","feature","indicesForCurrentFeature","verticesForCurrentFeature","normalsForCurrentFeature","vertexSize","i","vertice","rendererService","createAttribute","createBuffer","createElements","rest","UNSIGNED_INT","count","destroy"],"mappings":"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","sourcesContent":["import { inject, injectable } from 'inversify';\nimport { TYPES } from '../../types';\nimport { gl } from '../renderer/gl';\nimport { IAttribute } from '../renderer/IAttribute';\nimport { IElements } from '../renderer/IElements';\nimport { IRendererService } from '../renderer/IRendererService';\nimport { IParseDataItem } from '../source/ISourceService';\nimport { ILayer } from './ILayerService';\nimport {\n  IAttributeScale,\n  IEncodeFeature,\n  IStyleAttribute,\n  IStyleAttributeInitializationOptions,\n  IStyleAttributeService,\n  IStyleAttributeUpdateOptions,\n  IVertexAttributeDescriptor,\n  Triangulation,\n} from './IStyleAttributeService';\nimport StyleAttribute from './StyleAttribute';\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nconst bytesPerElementMap = {\n  [gl.FLOAT]: 4,\n  [gl.UNSIGNED_BYTE]: 1,\n  [gl.UNSIGNED_SHORT]: 2,\n};\n\n/**\n * 每个 Layer 都拥有一个，用于管理样式属性的注册和更新\n */\n@injectable()\nexport default class StyleAttributeService implements IStyleAttributeService {\n  public attributesAndIndices: {\n    attributes: {\n      [attributeName: string]: IAttribute;\n    };\n    elements: IElements;\n  };\n  @inject(TYPES.IRendererService)\n  private readonly rendererService: IRendererService;\n\n  private attributes: IStyleAttribute[] = [];\n  private triangulation: Triangulation;\n\n  private featureLayout: {\n    sizePerElement: number;\n    elements: Array<{\n      featureIdx: number;\n      vertices: number[];\n      normals: number[];\n      offset: number;\n    }>;\n  } = {\n    sizePerElement: 0,\n    elements: [],\n  };\n  public registerStyleAttribute(\n    options: Partial<IStyleAttributeInitializationOptions>,\n  ) {\n    let attributeToUpdate = this.getLayerStyleAttribute(options.name || '');\n    if (attributeToUpdate) {\n      attributeToUpdate.setProps(options);\n    } else {\n      attributeToUpdate = new StyleAttribute(options);\n      this.attributes.push(attributeToUpdate);\n    }\n    return attributeToUpdate;\n  }\n\n  public updateStyleAttribute(\n    attributeName: string,\n    options: Partial<IStyleAttributeInitializationOptions>,\n    updateOptions?: Partial<IStyleAttributeUpdateOptions>,\n  ) {\n    let attributeToUpdate = this.getLayerStyleAttribute(attributeName);\n    if (!attributeToUpdate) {\n      attributeToUpdate = this.registerStyleAttribute({\n        ...options,\n        name: attributeName,\n      });\n    }\n    const { scale } = options;\n    if (scale && attributeToUpdate) {\n      // TODO: 需要比较新旧值确定是否需要 rescale\n      // 需要重新 scale，肯定也需要重新进行数据映射\n      attributeToUpdate.scale = scale;\n      attributeToUpdate.needRescale = true;\n      attributeToUpdate.needRemapping = true;\n      attributeToUpdate.needRegenerateVertices = true;\n      if (updateOptions && updateOptions.featureRange) {\n        attributeToUpdate.featureRange = updateOptions.featureRange;\n      }\n    }\n  }\n\n  public getLayerStyleAttributes(): IStyleAttribute[] | undefined {\n    return this.attributes;\n  }\n\n  public getLayerStyleAttribute(\n    attributeName: string,\n  ): IStyleAttribute | undefined {\n    return this.attributes.find(\n      (attribute) => attribute.name === attributeName,\n    );\n  }\n\n  public getLayerAttributeScale(name: string) {\n    const attribute = this.getLayerStyleAttribute(name);\n    const scale = attribute?.scale?.scalers as IAttributeScale[];\n    if (scale && scale[0]) {\n      return scale[0].func;\n    }\n    return null;\n  }\n\n  public updateAttributeByFeatureRange(\n    attributeName: string,\n    features: IEncodeFeature[],\n    startFeatureIdx: number = 0,\n    endFeatureIdx?: number,\n  ) {\n    const attributeToUpdate = this.attributes.find(\n      (attribute) => attribute.name === attributeName,\n    );\n    if (attributeToUpdate && attributeToUpdate.descriptor) {\n      const { descriptor } = attributeToUpdate;\n      const { update, buffer, size = 0 } = descriptor;\n      const bytesPerElement = bytesPerElementMap[buffer.type || gl.FLOAT];\n      if (update) {\n        const { elements, sizePerElement } = this.featureLayout;\n        // 截取待更新的 feature 范围\n        const featuresToUpdate = elements.slice(startFeatureIdx, endFeatureIdx);\n        // [n, n] 中断更新\n        if (!featuresToUpdate.length) {\n          return;\n        }\n        const { offset } = featuresToUpdate[0];\n        // 以 byte 为单位计算 buffer 中的偏移\n        const bufferOffsetInBytes = offset * size * bytesPerElement;\n        const updatedBufferData = featuresToUpdate\n          .map(({ featureIdx, vertices, normals }, attributeIdx) => {\n            const verticesNumForCurrentFeature =\n              vertices.length / sizePerElement;\n            const featureData: number[] = [];\n            for (\n              let vertexIdx = 0;\n              vertexIdx < verticesNumForCurrentFeature;\n              vertexIdx++\n            ) {\n              const normal = normals\n                ? normals!.slice(vertexIdx * 3, vertexIdx * 3 + 3)\n                : [];\n              featureData.push(\n                ...update(\n                  features[featureIdx],\n                  featureIdx,\n                  vertices.slice(\n                    vertexIdx * sizePerElement,\n                    vertexIdx * sizePerElement + sizePerElement,\n                  ),\n                  attributeIdx,\n                  normal,\n                ),\n              );\n            }\n            return featureData;\n          })\n          .reduce((prev, cur) => {\n            prev.push(...cur);\n            return prev;\n          }, []);\n\n        // 更新底层 IAttribute 中包含的 IBuffer，使用 subdata\n        attributeToUpdate.vertexAttribute.updateBuffer({\n          data: updatedBufferData,\n          offset: bufferOffsetInBytes,\n        });\n      }\n    }\n  }\n\n  public createAttributesAndIndices(\n    features: IEncodeFeature[],\n    triangulation: Triangulation,\n  ): {\n    attributes: {\n      [attributeName: string]: IAttribute;\n    };\n    elements: IElements;\n  } {\n    // 每次创建的初始化化 LayerOut\n    this.featureLayout = {\n      sizePerElement: 0,\n      elements: [],\n    };\n    if (triangulation) {\n      this.triangulation = triangulation;\n    }\n    const descriptors = this.attributes.map((attr) => {\n      attr.resetDescriptor();\n      return attr.descriptor;\n    });\n    let verticesNum = 0;\n    const vertices: number[] = [];\n    const indices: number[] = [];\n    const normals: number[] = [];\n    let size = 3;\n    features.forEach((feature, featureIdx) => {\n      // 逐 feature 进行三角化\n      const {\n        indices: indicesForCurrentFeature,\n        vertices: verticesForCurrentFeature,\n        normals: normalsForCurrentFeature,\n        size: vertexSize,\n      } = this.triangulation(feature);\n      indicesForCurrentFeature.forEach((i) => {\n        indices.push(i + verticesNum);\n      });\n      size = vertexSize;\n      const verticesNumForCurrentFeature =\n        verticesForCurrentFeature.length / vertexSize;\n\n      // 记录三角化结果，用于后续精确更新指定 feature\n      this.featureLayout.sizePerElement = size;\n      this.featureLayout.elements.push({\n        featureIdx,\n        vertices: verticesForCurrentFeature,\n        normals: normalsForCurrentFeature as number[],\n        offset: verticesNum,\n      });\n\n      verticesNum += verticesNumForCurrentFeature;\n      // 根据 position 顶点生成其他顶点数据\n      for (\n        let vertexIdx = 0;\n        vertexIdx < verticesNumForCurrentFeature;\n        vertexIdx++\n      ) {\n        const normal =\n          normalsForCurrentFeature?.slice(vertexIdx * 3, vertexIdx * 3 + 3) ||\n          [];\n        const vertice = verticesForCurrentFeature.slice(\n          vertexIdx * vertexSize,\n          vertexIdx * vertexSize + vertexSize,\n        );\n        descriptors.forEach((descriptor, attributeIdx) => {\n          if (descriptor && descriptor.update) {\n            (descriptor.buffer.data as number[]).push(\n              ...descriptor.update(\n                feature,\n                featureIdx,\n                vertice,\n                vertexIdx, // 当前顶点所在feature索引\n                normal,\n                // TODO: 传入顶点索引 vertexIdx\n              ),\n            );\n          } // end if\n        }); // end for each\n      } // end for\n    }); // end features for Each\n    const {\n      createAttribute,\n      createBuffer,\n      createElements,\n    } = this.rendererService;\n\n    const attributes: {\n      [attributeName: string]: IAttribute;\n    } = {};\n    descriptors.forEach((descriptor, attributeIdx) => {\n      if (descriptor) {\n        // IAttribute 参数透传\n        const { buffer, update, name, ...rest } = descriptor;\n\n        const vertexAttribute = createAttribute({\n          // IBuffer 参数透传\n          buffer: createBuffer(buffer),\n          ...rest,\n        });\n        attributes[descriptor.name || ''] = vertexAttribute;\n\n        // 在 StyleAttribute 上保存对 VertexAttribute 的引用\n        this.attributes[attributeIdx].vertexAttribute = vertexAttribute;\n      }\n    });\n\n    const elements = createElements({\n      data: indices,\n      type: gl.UNSIGNED_INT,\n      count: indices.length,\n    });\n    this.attributesAndIndices = {\n      attributes,\n      elements,\n    };\n    return this.attributesAndIndices;\n  }\n  public clearAllAttributes() {\n    // 销毁关联的 vertex attribute buffer objects\n    this.attributes.forEach((attribute) => {\n      if (attribute.vertexAttribute) {\n        attribute.vertexAttribute.destroy();\n      }\n    });\n\n    this.attributesAndIndices?.elements.destroy();\n    this.attributes = [];\n  }\n}\n"],"file":"StyleAttributeService.js"}