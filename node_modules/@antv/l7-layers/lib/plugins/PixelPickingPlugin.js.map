{"version":3,"sources":["../../src/plugins/PixelPickingPlugin.ts"],"names":["PickingStage","NONE","ENCODE","HIGHLIGHT","PixelPickingPlugin","layer","rendererService","styleAttributeService","hooks","init","tap","getLayerConfig","enablePicking","registerStyleAttribute","name","type","AttributeType","Attribute","descriptor","buffer","data","gl","FLOAT","size","update","feature","featureIdx","id","beforePickingEncode","isVisible","models","forEach","model","addUniforms","u_PickingStage","afterPickingEncode","beforeHighlight","pickedColor","highlightColor","highlightColorInArray","updateLayerConfig","pickedFeatureID","Uint8Array","u_PickingColor","u_HighlightColor","map","c","beforeSelect","selectColor"],"mappings":"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","sourcesContent":["import {\n  AttributeType,\n  gl,\n  IEncodeFeature,\n  ILayer,\n  ILayerPlugin,\n  IRendererService,\n  IStyleAttributeService,\n} from '@antv/l7-core';\nimport {\n  decodePickingColor,\n  encodePickingColor,\n  rgb2arr,\n} from '@antv/l7-utils';\nimport { injectable } from 'inversify';\n\nconst PickingStage = {\n  NONE: 0.0,\n  ENCODE: 1.0,\n  HIGHLIGHT: 2.0,\n};\n\n@injectable()\nexport default class PixelPickingPlugin implements ILayerPlugin {\n  public apply(\n    layer: ILayer,\n    {\n      rendererService,\n      styleAttributeService,\n    }: {\n      rendererService: IRendererService;\n      styleAttributeService: IStyleAttributeService;\n    },\n  ) {\n    // TODO: 由于 Shader 目前无法根据是否开启拾取进行内容修改，因此即使不开启也需要生成 a_PickingColor\n    layer.hooks.init.tap('PixelPickingPlugin', () => {\n      const { enablePicking } = layer.getLayerConfig();\n      styleAttributeService.registerStyleAttribute({\n        name: 'pickingColor',\n        type: AttributeType.Attribute,\n        descriptor: {\n          name: 'a_PickingColor',\n          buffer: {\n            data: [],\n            type: gl.FLOAT,\n          },\n          size: 3,\n          // TODO: 固定 feature range 范围内的 pickingColor 都是固定的，可以生成 cache\n          update: (feature: IEncodeFeature, featureIdx: number) => {\n            // 只有开启拾取才需要 encode\n            const { id } = feature;\n            return enablePicking ? encodePickingColor(id as number) : [0, 0, 0];\n          },\n        },\n      });\n    });\n    // 必须要与 PixelPickingPass 结合使用，因此必须开启 multiPassRenderer\n    // if (layer.multiPassRenderer) {\n    layer.hooks.beforePickingEncode.tap('PixelPickingPlugin', () => {\n      const { enablePicking } = layer.getLayerConfig();\n      if (enablePicking && layer.isVisible()) {\n        layer.models.forEach((model) =>\n          model.addUniforms({\n            u_PickingStage: PickingStage.ENCODE,\n          }),\n        );\n      }\n    });\n\n    layer.hooks.afterPickingEncode.tap('PixelPickingPlugin', () => {\n      const { enablePicking } = layer.getLayerConfig();\n      // 区分选中高亮 和滑过高亮\n      if (enablePicking && layer.isVisible()) {\n        layer.models.forEach((model) =>\n          model.addUniforms({\n            u_PickingStage: PickingStage.HIGHLIGHT,\n          }),\n        );\n      }\n    });\n\n    layer.hooks.beforeHighlight.tap(\n      'PixelPickingPlugin',\n      (pickedColor: number[]) => {\n        const { highlightColor } = layer.getLayerConfig();\n        const highlightColorInArray =\n          typeof highlightColor === 'string'\n            ? rgb2arr(highlightColor)\n            : highlightColor || [1, 0, 0, 1];\n        layer.updateLayerConfig({\n          pickedFeatureID: decodePickingColor(new Uint8Array(pickedColor)),\n        });\n        layer.models.forEach((model) =>\n          model.addUniforms({\n            u_PickingStage: PickingStage.HIGHLIGHT,\n            u_PickingColor: pickedColor,\n            u_HighlightColor: highlightColorInArray.map((c) => c * 255),\n          }),\n        );\n      },\n    );\n\n    layer.hooks.beforeSelect.tap(\n      'PixelPickingPlugin',\n      (pickedColor: number[]) => {\n        const { selectColor } = layer.getLayerConfig();\n        const highlightColorInArray =\n          typeof selectColor === 'string'\n            ? rgb2arr(selectColor)\n            : selectColor || [1, 0, 0, 1];\n        layer.updateLayerConfig({\n          pickedFeatureID: decodePickingColor(new Uint8Array(pickedColor)),\n        });\n        layer.models.forEach((model) =>\n          model.addUniforms({\n            u_PickingStage: PickingStage.HIGHLIGHT,\n            u_PickingColor: pickedColor,\n            u_HighlightColor: highlightColorInArray.map((c) => c * 255),\n          }),\n        );\n      },\n    );\n    // }\n  }\n}\n"],"file":"PixelPickingPlugin.js"}