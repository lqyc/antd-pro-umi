{"version":3,"sources":["../src/source.ts"],"names":["mergeCustomizer","objValue","srcValue","Array","isArray","Source","data","cfg","extent","hooks","init","SyncHook","parser","type","transforms","cluster","clusterOptions","enable","radius","maxZoom","zoom","method","originData","rawData","clusterIndex","initCfg","tap","excuteParser","initCluster","executeTrans","options","emit","getClusters","id","getLeaves","Infinity","field","newBounds","concat","Math","floor","forEach","p","properties","point_count","map","item","points","d","statNum","column","statMap","stat","features","feature","length","newFeature","dataArray","find","dataItem","_id","value","name","removeAllListeners","option","sourceParser","trans","tran","Object","assign","call","EventEmitter"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport { SyncHook } from '@antv/async-hook';\nimport {\n  IClusterOptions,\n  IMapService,\n  IParseDataItem,\n  IParserCfg,\n  IParserData,\n  ISourceCFG,\n  ITransform,\n  lazyInject,\n  TYPES,\n} from '@antv/l7-core';\nimport { bBoxToBounds, extent, padBounds } from '@antv/l7-utils';\nimport {\n  BBox,\n  Feature,\n  FeatureCollection,\n  Geometries,\n  Properties,\n} from '@turf/helpers';\nimport { EventEmitter } from 'eventemitter3';\nimport { cloneDeep, isFunction, isString, mergeWith } from 'lodash';\n// @ts-ignore\n// tslint:disable-next-line:no-submodule-imports\nimport Supercluster from 'supercluster/dist/supercluster';\nimport { getParser, getTransform } from './';\nimport { cluster } from './transform/cluster';\nimport { statMap } from './utils/statistics';\nimport { getColumn } from './utils/util';\nfunction mergeCustomizer(objValue: any, srcValue: any) {\n  if (Array.isArray(srcValue)) {\n    return srcValue;\n  }\n}\n\nexport default class Source extends EventEmitter {\n  public data: IParserData;\n\n  // 数据范围\n  public extent: BBox;\n  // 生命周期钩子\n  public hooks = {\n    init: new SyncHook(),\n  };\n\n  public parser: IParserCfg = { type: 'geojson' };\n  public transforms: ITransform[] = [];\n  public cluster: boolean = false;\n  public clusterOptions: Partial<IClusterOptions> = {\n    enable: false,\n    radius: 40,\n    maxZoom: 20,\n    zoom: -99,\n    method: 'count',\n  };\n\n  // 原始数据\n  private originData: any;\n  private rawData: any;\n  private cfg: any = {};\n\n  private clusterIndex: Supercluster;\n\n  constructor(data: any, cfg?: ISourceCFG) {\n    super();\n    // this.rawData = cloneDeep(data);\n    this.originData = data;\n\n    this.initCfg(cfg);\n\n    this.hooks.init.tap('parser', () => {\n      this.excuteParser();\n    });\n    this.hooks.init.tap('cluster', () => {\n      this.initCluster();\n    });\n    this.hooks.init.tap('transform', () => {\n      this.executeTrans();\n    });\n    this.init();\n  }\n\n  public setData(data: any, options?: ISourceCFG) {\n    this.rawData = data;\n    this.originData = data;\n    this.initCfg(options);\n    this.init();\n    this.emit('update');\n  }\n  public getClusters(zoom: number): any {\n    return this.clusterIndex.getClusters(this.extent, zoom);\n  }\n  public getClustersLeaves(id: number): any {\n    return this.clusterIndex.getLeaves(id, Infinity);\n  }\n  public updateClusterData(zoom: number): void {\n    const { method = 'sum', field } = this.clusterOptions;\n    const newBounds = padBounds(bBoxToBounds(this.extent), 2);\n    let data = this.clusterIndex.getClusters(\n      newBounds[0].concat(newBounds[1]),\n      Math.floor(zoom),\n    );\n    this.clusterOptions.zoom = zoom;\n    data.forEach((p: any) => {\n      if (!p.id) {\n        p.properties.point_count = 1;\n      }\n    });\n    if (field || isFunction(method)) {\n      data = data.map((item: any) => {\n        const id = item.id as number;\n        if (id) {\n          const points = this.clusterIndex.getLeaves(id, Infinity);\n          const properties = points.map((d: any) => d.properties);\n          let statNum;\n          if (isString(method) && field) {\n            const column = getColumn(properties, field);\n            statNum = statMap[method](column);\n          }\n          if (isFunction(method)) {\n            statNum = method(properties);\n          }\n          item.properties.stat = statNum;\n        } else {\n          item.properties.point_count = 1;\n        }\n        return item;\n      });\n    }\n    this.data = getParser('geojson')({\n      type: 'FeatureCollection',\n      features: data,\n    });\n    this.executeTrans();\n  }\n  public getFeatureById(id: number): unknown {\n    const { type = 'geojson' } = this.parser;\n    if (type === 'geojson' && !this.cluster) {\n      const feature =\n        id < this.originData.features.length\n          ? this.originData.features[id]\n          : 'null';\n      const newFeature = cloneDeep(feature);\n      if (this.transforms.length !== 0) {\n        const item = this.data.dataArray.find((dataItem: IParseDataItem) => {\n          return dataItem._id === id;\n        });\n        newFeature.properties = item;\n      }\n      return newFeature;\n    } else {\n      return id < this.data.dataArray.length ? this.data.dataArray[id] : 'null';\n    }\n  }\n\n  public getFeatureId(field: string, value: any): number | undefined {\n    const feature = this.data.dataArray.find((dataItem: IParseDataItem) => {\n      return dataItem[field] === name;\n    });\n    return feature?._id;\n  }\n\n  public destroy() {\n    this.removeAllListeners();\n    this.originData = null;\n    this.clusterIndex = null;\n    // @ts-ignore\n    this.data = null;\n  }\n\n  private initCfg(option?: ISourceCFG) {\n    this.cfg = mergeWith(this.cfg, option, mergeCustomizer);\n    const cfg = this.cfg;\n    if (cfg) {\n      if (cfg.parser) {\n        this.parser = cfg.parser;\n      }\n      if (cfg.transforms) {\n        this.transforms = cfg.transforms;\n      }\n      this.cluster = cfg.cluster || false;\n      if (cfg.clusterOptions) {\n        this.cluster = true;\n        this.clusterOptions = {\n          ...this.clusterOptions,\n          ...cfg.clusterOptions,\n        };\n      }\n    }\n  }\n  private excuteParser(): void {\n    const parser = this.parser;\n    const type: string = parser.type || 'geojson';\n    const sourceParser = getParser(type);\n    this.data = sourceParser(this.originData, parser);\n    // 计算范围\n    this.extent = extent(this.data.dataArray);\n  }\n  /**\n   * 数据统计\n   */\n  private executeTrans() {\n    const trans = this.transforms;\n    trans.forEach((tran: ITransform) => {\n      const { type } = tran;\n      const data = getTransform(type)(this.data, tran);\n      Object.assign(this.data, data);\n    });\n  }\n\n  private initCluster() {\n    if (!this.cluster) {\n      return;\n    }\n\n    const clusterOptions = this.clusterOptions || {};\n    this.clusterIndex = cluster(this.data, clusterOptions);\n  }\n\n  private init() {\n    this.hooks.init.call(this);\n  }\n}\n"],"file":"source.js"}