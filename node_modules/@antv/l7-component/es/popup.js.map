{"version":3,"sources":["../src/popup.ts"],"names":["TYPES","anchorTranslate","anchorType","applyAnchorClass","bindAll","DOM","EventEmitter","Popup","cfg","popupOption","mapsService","sceneSerive","lngLat","content","closeButton","timeoutInstance","container","tip","scene","getdefault","get","IMapService","ISceneService","on","update","closeOnClick","setTimeout","onClickClose","emit","remove","addTo","html","frag","window","document","createDocumentFragment","temp","createElement","child","innerHTML","firstChild","appendChild","setDOMContent","Array","isArray","lng","lat","text","createTextNode","maxWidth","htmlNode","createContent","removeDom","off","clearTimeout","create","setAttribute","addEventListener","tagName","className","el","undefined","node","parentNode","removeChild","offsets","anchor","BOTTOM","stopPropagation","e","hasPosition","popupContainer","getMarkerContainer","creatDom","split","forEach","name","classList","add","type","style","updatePosition","setTransform","pos","lngLatToContainer","left","x","top","y"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IPoint,\n  IPopup,\n  IPopupOption,\n  ISceneService,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n/** colse event */\n\nexport default class Popup extends EventEmitter implements IPopup {\n  private popupOption: IPopupOption;\n  private mapsService: IMapService<unknown>;\n  private sceneSerive: ISceneService;\n  private lngLat: ILngLat;\n  private content: HTMLElement;\n  private closeButton: HTMLElement;\n  private timeoutInstance: any;\n  private container: HTMLElement;\n  private tip: HTMLElement;\n  private scene: Container;\n\n  constructor(cfg?: Partial<IPopupOption>) {\n    super();\n    this.popupOption = {\n      ...this.getdefault(),\n      ...cfg,\n    };\n    bindAll(['update', 'onClickClose', 'remove'], this);\n  }\n\n  public addTo(scene: Container) {\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.sceneSerive = scene.get<ISceneService>(TYPES.ISceneService);\n    this.mapsService.on('camerachange', this.update);\n    this.scene = scene;\n    this.update();\n    if (this.popupOption.closeOnClick) {\n      this.timeoutInstance = setTimeout(() => {\n        this.mapsService.on('click', this.onClickClose);\n      }, 30);\n    }\n    this.emit('open');\n    return this;\n  }\n\n  public close(): void {\n    this.remove();\n  }\n\n  public open(): void {\n    this.addTo(this.scene);\n  }\n\n  public setHTML(html: string) {\n    const frag = window.document.createDocumentFragment();\n    const temp = window.document.createElement('body');\n    let child: ChildNode | null;\n    temp.innerHTML = html;\n    while (true) {\n      child = temp.firstChild;\n      if (!child) {\n        break;\n      }\n      frag.appendChild(child);\n    }\n\n    return this.setDOMContent(frag);\n  }\n\n  public setLnglat(lngLat: ILngLat | number[]): this {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n    if (this.mapsService) {\n      this.mapsService.on('camerachange', this.update);\n    }\n    this.update();\n    return this;\n  }\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n  public setText(text: string) {\n    return this.setDOMContent(window.document.createTextNode(text));\n  }\n\n  public setMaxWidth(maxWidth: string): this {\n    this.popupOption.maxWidth = maxWidth;\n    this.update();\n    return this;\n  }\n\n  public setDOMContent(htmlNode: ChildNode | DocumentFragment) {\n    this.createContent();\n    this.content.appendChild(htmlNode);\n    this.update();\n    return this;\n  }\n\n  // 移除popup\n  public remove() {\n    if (this.content) {\n      this.removeDom(this.content);\n    }\n\n    if (this.container) {\n      this.removeDom(this.container);\n      delete this.container;\n    }\n    if (this.mapsService) {\n      // TODO: mapbox AMap 事件同步\n      this.mapsService.off('camerachange', this.update);\n      this.mapsService.off('click', this.onClickClose);\n      delete this.mapsService;\n    }\n    clearTimeout(this.timeoutInstance);\n    this.emit('close');\n    return this;\n  }\n  public isOpen() {\n    return !!this.mapsService;\n  }\n\n  private createContent() {\n    if (this.content) {\n      DOM.remove(this.content);\n    }\n    this.content = DOM.create('div', 'l7-popup-content', this.container);\n    if (this.popupOption.closeButton) {\n      this.closeButton = DOM.create(\n        'button',\n        'l7-popup-close-button',\n        this.content,\n      );\n      // this.closeButton.type = 'button';\n      this.closeButton.setAttribute('aria-label', 'Close popup');\n      this.closeButton.innerHTML = '&#215;';\n      this.closeButton.addEventListener('click', this.onClickClose);\n    }\n  }\n\n  private creatDom(tagName: string, className: string, container: HTMLElement) {\n    const el = window.document.createElement(tagName);\n    if (className !== undefined) {\n      el.className = className;\n    }\n    if (container) {\n      container.appendChild(el);\n    }\n    return el;\n  }\n\n  private removeDom(node: ChildNode) {\n    if (node.parentNode) {\n      node.parentNode.removeChild(node);\n    }\n  }\n\n  private getdefault() {\n    return {\n      closeButton: true,\n      closeOnClick: true,\n      maxWidth: '240px',\n      offsets: [0, 0],\n      anchor: anchorType.BOTTOM,\n      className: '',\n      stopPropagation: true,\n    };\n  }\n\n  private onClickClose(e: Event) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    }\n    this.remove();\n  }\n\n  private update() {\n    const hasPosition = this.lngLat;\n    const { className, maxWidth, anchor } = this.popupOption;\n    if (!this.mapsService || !hasPosition || !this.content) {\n      return;\n    }\n    const popupContainer = this.mapsService.getMarkerContainer();\n    if (!this.container && popupContainer) {\n      this.container = this.creatDom(\n        'div',\n        'l7-popup',\n        popupContainer as HTMLElement,\n      );\n\n      this.tip = this.creatDom('div', 'l7-popup-tip', this.container);\n      this.container.appendChild(this.content);\n      if (className) {\n        className\n          .split(' ')\n          .forEach((name) => this.container.classList.add(name));\n      }\n\n      // 高德地图需要阻止事件冒泡 // 测试mapbox 地图不需要添加\n      const { stopPropagation } = this.popupOption;\n      if (stopPropagation) {\n        ['mousemove', 'mousedown', 'mouseup', 'click', 'dblclick'].forEach(\n          (type) => {\n            this.container.addEventListener(type, (e) => {\n              e.stopPropagation();\n            });\n          },\n        );\n      }\n    }\n    if (maxWidth && this.container.style.maxWidth !== maxWidth) {\n      this.container.style.maxWidth = maxWidth;\n    }\n\n    this.updatePosition();\n    DOM.setTransform(this.container, `${anchorTranslate[anchor]}`);\n    applyAnchorClass(this.container, anchor, 'popup');\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { lng, lat } = this.lngLat;\n    const { offsets } = this.popupOption;\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n    this.container.style.left = pos.x + offsets[0] + 'px';\n    this.container.style.top = pos.y - offsets[1] + 'px';\n  }\n}\n"],"file":"popup.js"}