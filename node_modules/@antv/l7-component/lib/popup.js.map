{"version":3,"sources":["../src/popup.ts"],"names":["Popup","cfg","popupOption","mapsService","sceneSerive","lngLat","content","closeButton","timeoutInstance","container","tip","scene","getdefault","get","TYPES","IMapService","ISceneService","on","update","closeOnClick","setTimeout","onClickClose","emit","remove","addTo","html","frag","window","document","createDocumentFragment","temp","createElement","child","innerHTML","firstChild","appendChild","setDOMContent","Array","isArray","lng","lat","text","createTextNode","maxWidth","htmlNode","createContent","removeDom","off","clearTimeout","DOM","create","setAttribute","addEventListener","tagName","className","el","undefined","node","parentNode","removeChild","offsets","anchor","anchorType","BOTTOM","stopPropagation","e","hasPosition","popupContainer","getMarkerContainer","creatDom","split","forEach","name","classList","add","type","style","updatePosition","setTransform","anchorTranslate","pos","lngLatToContainer","left","x","top","y","EventEmitter"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IPoint,\n  IPopup,\n  IPopupOption,\n  ISceneService,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n/** colse event */\n\nexport default class Popup extends EventEmitter implements IPopup {\n  private popupOption: IPopupOption;\n  private mapsService: IMapService<unknown>;\n  private sceneSerive: ISceneService;\n  private lngLat: ILngLat;\n  private content: HTMLElement;\n  private closeButton: HTMLElement;\n  private timeoutInstance: any;\n  private container: HTMLElement;\n  private tip: HTMLElement;\n  private scene: Container;\n\n  constructor(cfg?: Partial<IPopupOption>) {\n    super();\n    this.popupOption = {\n      ...this.getdefault(),\n      ...cfg,\n    };\n    bindAll(['update', 'onClickClose', 'remove'], this);\n  }\n\n  public addTo(scene: Container) {\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.sceneSerive = scene.get<ISceneService>(TYPES.ISceneService);\n    this.mapsService.on('camerachange', this.update);\n    this.scene = scene;\n    this.update();\n    if (this.popupOption.closeOnClick) {\n      this.timeoutInstance = setTimeout(() => {\n        this.mapsService.on('click', this.onClickClose);\n      }, 30);\n    }\n    this.emit('open');\n    return this;\n  }\n\n  public close(): void {\n    this.remove();\n  }\n\n  public open(): void {\n    this.addTo(this.scene);\n  }\n\n  public setHTML(html: string) {\n    const frag = window.document.createDocumentFragment();\n    const temp = window.document.createElement('body');\n    let child: ChildNode | null;\n    temp.innerHTML = html;\n    while (true) {\n      child = temp.firstChild;\n      if (!child) {\n        break;\n      }\n      frag.appendChild(child);\n    }\n\n    return this.setDOMContent(frag);\n  }\n\n  public setLnglat(lngLat: ILngLat | number[]): this {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n    if (this.mapsService) {\n      this.mapsService.on('camerachange', this.update);\n    }\n    this.update();\n    return this;\n  }\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n  public setText(text: string) {\n    return this.setDOMContent(window.document.createTextNode(text));\n  }\n\n  public setMaxWidth(maxWidth: string): this {\n    this.popupOption.maxWidth = maxWidth;\n    this.update();\n    return this;\n  }\n\n  public setDOMContent(htmlNode: ChildNode | DocumentFragment) {\n    this.createContent();\n    this.content.appendChild(htmlNode);\n    this.update();\n    return this;\n  }\n\n  // 移除popup\n  public remove() {\n    if (this.content) {\n      this.removeDom(this.content);\n    }\n\n    if (this.container) {\n      this.removeDom(this.container);\n      delete this.container;\n    }\n    if (this.mapsService) {\n      // TODO: mapbox AMap 事件同步\n      this.mapsService.off('camerachange', this.update);\n      this.mapsService.off('click', this.onClickClose);\n      delete this.mapsService;\n    }\n    clearTimeout(this.timeoutInstance);\n    this.emit('close');\n    return this;\n  }\n  public isOpen() {\n    return !!this.mapsService;\n  }\n\n  private createContent() {\n    if (this.content) {\n      DOM.remove(this.content);\n    }\n    this.content = DOM.create('div', 'l7-popup-content', this.container);\n    if (this.popupOption.closeButton) {\n      this.closeButton = DOM.create(\n        'button',\n        'l7-popup-close-button',\n        this.content,\n      );\n      // this.closeButton.type = 'button';\n      this.closeButton.setAttribute('aria-label', 'Close popup');\n      this.closeButton.innerHTML = '&#215;';\n      this.closeButton.addEventListener('click', this.onClickClose);\n    }\n  }\n\n  private creatDom(tagName: string, className: string, container: HTMLElement) {\n    const el = window.document.createElement(tagName);\n    if (className !== undefined) {\n      el.className = className;\n    }\n    if (container) {\n      container.appendChild(el);\n    }\n    return el;\n  }\n\n  private removeDom(node: ChildNode) {\n    if (node.parentNode) {\n      node.parentNode.removeChild(node);\n    }\n  }\n\n  private getdefault() {\n    return {\n      closeButton: true,\n      closeOnClick: true,\n      maxWidth: '240px',\n      offsets: [0, 0],\n      anchor: anchorType.BOTTOM,\n      className: '',\n      stopPropagation: true,\n    };\n  }\n\n  private onClickClose(e: Event) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    }\n    this.remove();\n  }\n\n  private update() {\n    const hasPosition = this.lngLat;\n    const { className, maxWidth, anchor } = this.popupOption;\n    if (!this.mapsService || !hasPosition || !this.content) {\n      return;\n    }\n    const popupContainer = this.mapsService.getMarkerContainer();\n    if (!this.container && popupContainer) {\n      this.container = this.creatDom(\n        'div',\n        'l7-popup',\n        popupContainer as HTMLElement,\n      );\n\n      this.tip = this.creatDom('div', 'l7-popup-tip', this.container);\n      this.container.appendChild(this.content);\n      if (className) {\n        className\n          .split(' ')\n          .forEach((name) => this.container.classList.add(name));\n      }\n\n      // 高德地图需要阻止事件冒泡 // 测试mapbox 地图不需要添加\n      const { stopPropagation } = this.popupOption;\n      if (stopPropagation) {\n        ['mousemove', 'mousedown', 'mouseup', 'click', 'dblclick'].forEach(\n          (type) => {\n            this.container.addEventListener(type, (e) => {\n              e.stopPropagation();\n            });\n          },\n        );\n      }\n    }\n    if (maxWidth && this.container.style.maxWidth !== maxWidth) {\n      this.container.style.maxWidth = maxWidth;\n    }\n\n    this.updatePosition();\n    DOM.setTransform(this.container, `${anchorTranslate[anchor]}`);\n    applyAnchorClass(this.container, anchor, 'popup');\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { lng, lat } = this.lngLat;\n    const { offsets } = this.popupOption;\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n    this.container.style.left = pos.x + offsets[0] + 'px';\n    this.container.style.top = pos.y - offsets[1] + 'px';\n  }\n}\n"],"file":"popup.js"}