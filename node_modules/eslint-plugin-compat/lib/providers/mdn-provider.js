"use strict";

require("core-js/modules/es.array.flat");

require("core-js/modules/es.array.unscopables.flat");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isSupportedByMDN = isSupportedByMDN;
exports.getUnsupportedTargets = getUnsupportedTargets;
exports.default = void 0;

var _astMetadataInferer = _interopRequireDefault(require("ast-metadata-inferer"));

var _semver = _interopRequireDefault(require("semver"));

var _helpers = require("../helpers");

var _constants = require("../constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const apis = _astMetadataInferer.default; // @TODO Import this type from ast-metadata-inferer after migrating this project to TypeScript

const mdnRecords = new Map(apis.map(e => [e.protoChainId, e]));

/**
 * Map ids of mdn targets to their "common/friendly" name
 */
const targetIdMappings = {
  chrome: "chrome",
  firefox: "firefox",
  opera: "opera",
  safari: "safari",
  safari_ios: "ios_saf",
  ie: "ie",
  edge_mobile: "ie_mob",
  edge: "edge",
  opera_android: "and_opera",
  chrome_android: "and_chrome",
  firefox_android: "and_firefox",
  webview_android: "and_webview",
  samsunginternet_android: "and_samsung",
  nodejs: "node"
};
const reversedTargetMappings = (0, _helpers.reverseTargetMappings)(targetIdMappings);
/**
 * Take a target's id and return it's full name by using `targetNameMappings`
 * ex. {target: and_ff, version: 40} => 'Android FireFox 40'
 */

function formatTargetNames(target) {
  return `${_constants.STANDARD_TARGET_NAME_MAPPING[target.target]} ${target.version}`;
}
/**
 * Convert '9' => '9.0.0'
 */


function customCoerce(version) {
  return version.length === 1 ? [version, 0, 0].join(".") : version;
}
/*
 * Return if MDN supports the API or not
 */


function isSupportedByMDN(node, {
  version,
  target: mdnTarget
}) {
  const target = reversedTargetMappings[mdnTarget]; // If no record could be found, return true. Rules might not
  // be found because they could belong to another provider

  if (!mdnRecords.has(node.protoChainId)) return true;
  const record = mdnRecords.get(node.protoChainId);
  if (!record || !record.compat.support) return true;
  const compatRecord = record.compat.support[target];
  if (!compatRecord) return true;
  if (!Array.isArray(compatRecord) && !("version_added" in compatRecord)) return true;
  const {
    version_added: versionAdded
  } = Array.isArray(compatRecord) ? compatRecord.find(e => "version_added" in e) : compatRecord; // If a version is true then it is supported but version is unsure

  if (typeof versionAdded === "boolean") return versionAdded;
  if (versionAdded === null) return true; // Special case for Safari TP: TP is always gte than any other releases

  if (target === "safari") {
    if (version === "TP") return true;
    if (versionAdded === "TP") return false;
  } // A browser supports an API if its version is greater than or equal
  // to the first version of the browser that API was added in


  const semverCurrent = _semver.default.coerce(customCoerce(version));

  const semverAdded = _semver.default.coerce(customCoerce(versionAdded)); // semver.coerce() might be null for non-semvers (other than Safari TP)
  // Just warn and treat features as supported here for now to avoid lint from
  // crashing


  if (!semverCurrent) {
    // eslint-disable-next-line no-console
    console.warn(`eslint-plugin-compat: A non-semver target "${target} ${version}" matched for the feature ${node.protoChainId}, skipping. You're welcome to submit this log to https://github.com/amilajack/eslint-plugin-compat/issues for analysis.`);
    return true;
  }

  if (!versionAdded) {
    // eslint-disable-next-line no-console
    console.warn(`eslint-plugin-compat: The feature ${node.protoChainId} is supported since a non-semver target "${target} ${versionAdded}", skipping. You're welcome to submit this log to https://github.com/amilajack/eslint-plugin-compat/issues for analysis.`);
    return true;
  }

  return _semver.default.gte(semverCurrent, semverAdded);
}
/**
 * Return an array of all unsupported targets
 */


function getUnsupportedTargets(node, targets) {
  return targets.filter(target => !isSupportedByMDN(node, target)).map(formatTargetNames);
}

function getMetadataName(metadata) {
  switch (metadata.protoChain.length) {
    case 1:
      {
        return metadata.protoChain[0];
      }

    default:
      return `${metadata.protoChain.join(".")}()`;
  }
}

const MdnProvider = apis // Create entries for each ast node type
.map(metadata => metadata.astNodeTypes.map(astNodeType => ({ ...metadata,
  name: getMetadataName(metadata),
  id: metadata.protoChainId,
  protoChainId: metadata.protoChainId,
  astNodeType,
  object: metadata.protoChain[0],
  // @TODO Handle cases where 'prototype' is in protoChain
  property: metadata.protoChain[1]
}))) // Flatten the array of arrays
.flat() // Add rule and target support logic for each entry
.map(rule => ({ ...rule,
  getUnsupportedTargets
}));
var _default = MdnProvider;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm92aWRlcnMvbWRuLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbImFwaXMiLCJhcGlNZXRhZGF0YSIsIm1kblJlY29yZHMiLCJNYXAiLCJtYXAiLCJlIiwicHJvdG9DaGFpbklkIiwidGFyZ2V0SWRNYXBwaW5ncyIsImNocm9tZSIsImZpcmVmb3giLCJvcGVyYSIsInNhZmFyaSIsInNhZmFyaV9pb3MiLCJpZSIsImVkZ2VfbW9iaWxlIiwiZWRnZSIsIm9wZXJhX2FuZHJvaWQiLCJjaHJvbWVfYW5kcm9pZCIsImZpcmVmb3hfYW5kcm9pZCIsIndlYnZpZXdfYW5kcm9pZCIsInNhbXN1bmdpbnRlcm5ldF9hbmRyb2lkIiwibm9kZWpzIiwicmV2ZXJzZWRUYXJnZXRNYXBwaW5ncyIsImZvcm1hdFRhcmdldE5hbWVzIiwidGFyZ2V0IiwiU1RBTkRBUkRfVEFSR0VUX05BTUVfTUFQUElORyIsInZlcnNpb24iLCJjdXN0b21Db2VyY2UiLCJsZW5ndGgiLCJqb2luIiwiaXNTdXBwb3J0ZWRCeU1ETiIsIm5vZGUiLCJtZG5UYXJnZXQiLCJoYXMiLCJyZWNvcmQiLCJnZXQiLCJjb21wYXQiLCJzdXBwb3J0IiwiY29tcGF0UmVjb3JkIiwiQXJyYXkiLCJpc0FycmF5IiwidmVyc2lvbl9hZGRlZCIsInZlcnNpb25BZGRlZCIsImZpbmQiLCJzZW12ZXJDdXJyZW50Iiwic2VtdmVyIiwiY29lcmNlIiwic2VtdmVyQWRkZWQiLCJjb25zb2xlIiwid2FybiIsImd0ZSIsImdldFVuc3VwcG9ydGVkVGFyZ2V0cyIsInRhcmdldHMiLCJmaWx0ZXIiLCJnZXRNZXRhZGF0YU5hbWUiLCJtZXRhZGF0YSIsInByb3RvQ2hhaW4iLCJNZG5Qcm92aWRlciIsImFzdE5vZGVUeXBlcyIsImFzdE5vZGVUeXBlIiwibmFtZSIsImlkIiwib2JqZWN0IiwicHJvcGVydHkiLCJmbGF0IiwicnVsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztB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LGVBQVQsQ0FBeUJDLFFBQXpCLEVBQWdEO0FBQzlDLFVBQVFBLFFBQVEsQ0FBQ0MsVUFBVCxDQUFvQjVCLE1BQTVCO0FBQ0UsU0FBSyxDQUFMO0FBQVE7QUFDTixlQUFPMkIsUUFBUSxDQUFDQyxVQUFULENBQW9CLENBQXBCLENBQVA7QUFDRDs7QUFDRDtBQUNFLGFBQVEsR0FBRUQsUUFBUSxDQUFDQyxVQUFULENBQW9CM0IsSUFBcEIsQ0FBeUIsR0FBekIsQ0FBOEIsSUFBeEM7QUFMSjtBQU9EOztBQUVELE1BQU00QixXQUFxRCxHQUFHekQsSUFBSSxDQUNoRTtBQURnRSxDQUUvREksR0FGMkQsQ0FFdERtRCxRQUFELElBQ0hBLFFBQVEsQ0FBQ0csWUFBVCxDQUFzQnRELEdBQXRCLENBQTJCdUQsV0FBRCxLQUFrQixFQUMxQyxHQUFHSixRQUR1QztBQUUxQ0ssRUFBQUEsSUFBSSxFQUFFTixlQUFlLENBQUNDLFFBQUQsQ0FGcUI7QUFHMUNNLEVBQUFBLEVBQUUsRUFBRU4sUUFBUSxDQUFDakQsWUFINkI7QUFJMUNBLEVBQUFBLFlBQVksRUFBRWlELFFBQVEsQ0FBQ2pELFlBSm1CO0FBSzFDcUQsRUFBQUEsV0FMMEM7QUFNMUNHLEVBQUFBLE1BQU0sRUFBRVAsUUFBUSxDQUFDQyxVQUFULENBQW9CLENBQXBCLENBTmtDO0FBTzFDO0FBQ0FPLEVBQUFBLFFBQVEsRUFBRVIsUUFBUSxDQUFDQyxVQUFULENBQW9CLENBQXBCO0FBUmdDLENBQWxCLENBQTFCLENBSDBELEVBYzVEO0FBZDRELENBZTNEUSxJQWYyRCxHQWdCNUQ7QUFoQjRELENBaUIzRDVELEdBakIyRCxDQWlCdEQ2RCxJQUFELEtBQVcsRUFDZCxHQUFHQSxJQURXO0FBRWRkLEVBQUFBO0FBRmMsQ0FBWCxDQWpCdUQsQ0FBOUQ7ZUFzQmVNLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXBpTWV0YWRhdGEgZnJvbSBcImFzdC1tZXRhZGF0YS1pbmZlcmVyXCI7XG5pbXBvcnQgc2VtdmVyIGZyb20gXCJzZW12ZXJcIjtcbmltcG9ydCB7IEFwaU1ldGFkYXRhIH0gZnJvbSBcImFzdC1tZXRhZGF0YS1pbmZlcmVyL2xpYi90eXBlc1wiO1xuaW1wb3J0IHsgcmV2ZXJzZVRhcmdldE1hcHBpbmdzIH0gZnJvbSBcIi4uL2hlbHBlcnNcIjtcbmltcG9ydCB7IFNUQU5EQVJEX1RBUkdFVF9OQU1FX01BUFBJTkcgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBBc3RNZXRhZGF0YUFwaVdpdGhUYXJnZXRzUmVzb2x2ZXIsIFRhcmdldCB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG5jb25zdCBhcGlzID0gYXBpTWV0YWRhdGEgYXMgQXBpTWV0YWRhdGFbXTtcblxuLy8gQFRPRE8gSW1wb3J0IHRoaXMgdHlwZSBmcm9tIGFzdC1tZXRhZGF0YS1pbmZlcmVyIGFmdGVyIG1pZ3JhdGluZyB0aGlzIHByb2plY3QgdG8gVHlwZVNjcmlwdFxuY29uc3QgbWRuUmVjb3JkczogTWFwPHN0cmluZywgQXBpTWV0YWRhdGE+ID0gbmV3IE1hcChcbiAgYXBpcy5tYXAoKGUpID0+IFtlLnByb3RvQ2hhaW5JZCwgZV0pXG4pO1xuXG5pbnRlcmZhY2UgVGFyZ2V0SWRNYXBwaW5ncyB7XG4gIGNocm9tZTogXCJjaHJvbWVcIjtcbiAgZmlyZWZveDogXCJmaXJlZm94XCI7XG4gIG9wZXJhOiBcIm9wZXJhXCI7XG4gIHNhZmFyaTogXCJzYWZhcmlcIjtcbiAgc2FmYXJpX2lvczogXCJpb3Nfc2FmXCI7XG4gIGllOiBcImllXCI7XG4gIGVkZ2VfbW9iaWxlOiBcImllX21vYlwiO1xuICBlZGdlOiBcImVkZ2VcIjtcbiAgb3BlcmFfYW5kcm9pZDogXCJhbmRfb3BlcmFcIjtcbiAgY2hyb21lX2FuZHJvaWQ6IFwiYW5kX2Nocm9tZVwiO1xuICBmaXJlZm94X2FuZHJvaWQ6IFwiYW5kX2ZpcmVmb3hcIjtcbiAgd2Vidmlld19hbmRyb2lkOiBcImFuZF93ZWJ2aWV3XCI7XG4gIHNhbXN1bmdpbnRlcm5ldF9hbmRyb2lkOiBcImFuZF9zYW1zdW5nXCI7XG4gIG5vZGVqczogXCJub2RlXCI7XG59XG5cbi8qKlxuICogTWFwIGlkcyBvZiBtZG4gdGFyZ2V0cyB0byB0aGVpciBcImNvbW1vbi9mcmllbmRseVwiIG5hbWVcbiAqL1xuY29uc3QgdGFyZ2V0SWRNYXBwaW5nczogUmVhZG9ubHk8VGFyZ2V0SWRNYXBwaW5ncz4gPSB7XG4gIGNocm9tZTogXCJjaHJvbWVcIixcbiAgZmlyZWZveDogXCJmaXJlZm94XCIsXG4gIG9wZXJhOiBcIm9wZXJhXCIsXG4gIHNhZmFyaTogXCJzYWZhcmlcIixcbiAgc2FmYXJpX2lvczogXCJpb3Nfc2FmXCIsXG4gIGllOiBcImllXCIsXG4gIGVkZ2VfbW9iaWxlOiBcImllX21vYlwiLFxuICBlZGdlOiBcImVkZ2VcIixcbiAgb3BlcmFfYW5kcm9pZDogXCJhbmRfb3BlcmFcIixcbiAgY2hyb21lX2FuZHJvaWQ6IFwiYW5kX2Nocm9tZVwiLFxuICBmaXJlZm94X2FuZHJvaWQ6IFwiYW5kX2ZpcmVmb3hcIixcbiAgd2Vidmlld19hbmRyb2lkOiBcImFuZF93ZWJ2aWV3XCIsXG4gIHNhbXN1bmdpbnRlcm5ldF9hbmRyb2lkOiBcImFuZF9zYW1zdW5nXCIsXG4gIG5vZGVqczogXCJub2RlXCIsXG59O1xuXG5jb25zdCByZXZlcnNlZFRhcmdldE1hcHBpbmdzID0gcmV2ZXJzZVRhcmdldE1hcHBpbmdzKHRhcmdldElkTWFwcGluZ3MpO1xuXG4vKipcbiAqIFRha2UgYSB0YXJnZXQncyBpZCBhbmQgcmV0dXJuIGl0J3MgZnVsbCBuYW1lIGJ5IHVzaW5nIGB0YXJnZXROYW1lTWFwcGluZ3NgXG4gKiBleC4ge3RhcmdldDogYW5kX2ZmLCB2ZXJzaW9uOiA0MH0gPT4gJ0FuZHJvaWQgRmlyZUZveCA0MCdcbiAqL1xuZnVuY3Rpb24gZm9ybWF0VGFyZ2V0TmFtZXModGFyZ2V0OiBUYXJnZXQpOiBzdHJpbmcge1xuICByZXR1cm4gYCR7U1RBTkRBUkRfVEFSR0VUX05BTUVfTUFQUElOR1t0YXJnZXQudGFyZ2V0XX0gJHt0YXJnZXQudmVyc2lvbn1gO1xufVxuXG4vKipcbiAqIENvbnZlcnQgJzknID0+ICc5LjAuMCdcbiAqL1xuZnVuY3Rpb24gY3VzdG9tQ29lcmNlKHZlcnNpb246IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiB2ZXJzaW9uLmxlbmd0aCA9PT0gMSA/IFt2ZXJzaW9uLCAwLCAwXS5qb2luKFwiLlwiKSA6IHZlcnNpb247XG59XG5cbi8qXG4gKiBSZXR1cm4gaWYgTUROIHN1cHBvcnRzIHRoZSBBUEkgb3Igbm90XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1N1cHBvcnRlZEJ5TUROKFxuICBub2RlOiBBc3RNZXRhZGF0YUFwaVdpdGhUYXJnZXRzUmVzb2x2ZXIsXG4gIHsgdmVyc2lvbiwgdGFyZ2V0OiBtZG5UYXJnZXQgfTogVGFyZ2V0XG4pOiBib29sZWFuIHtcbiAgY29uc3QgdGFyZ2V0ID0gcmV2ZXJzZWRUYXJnZXRNYXBwaW5nc1ttZG5UYXJnZXRdO1xuICAvLyBJZiBubyByZWNvcmQgY291bGQgYmUgZm91bmQsIHJldHVybiB0cnVlLiBSdWxlcyBtaWdodCBub3RcbiAgLy8gYmUgZm91bmQgYmVjYXVzZSB0aGV5IGNvdWxkIGJlbG9uZyB0byBhbm90aGVyIHByb3ZpZGVyXG4gIGlmICghbWRuUmVjb3Jkcy5oYXMobm9kZS5wcm90b0NoYWluSWQpKSByZXR1cm4gdHJ1ZTtcbiAgY29uc3QgcmVjb3JkID0gbWRuUmVjb3Jkcy5nZXQobm9kZS5wcm90b0NoYWluSWQpO1xuICBpZiAoIXJlY29yZCB8fCAhcmVjb3JkLmNvbXBhdC5zdXBwb3J0KSByZXR1cm4gdHJ1ZTtcbiAgY29uc3QgY29tcGF0UmVjb3JkID0gcmVjb3JkLmNvbXBhdC5zdXBwb3J0W3RhcmdldF07XG4gIGlmICghY29tcGF0UmVjb3JkKSByZXR1cm4gdHJ1ZTtcbiAgaWYgKCFBcnJheS5pc0FycmF5KGNvbXBhdFJlY29yZCkgJiYgIShcInZlcnNpb25fYWRkZWRcIiBpbiBjb21wYXRSZWNvcmQpKVxuICAgIHJldHVybiB0cnVlO1xuICBjb25zdCB7IHZlcnNpb25fYWRkZWQ6IHZlcnNpb25BZGRlZCB9ID0gQXJyYXkuaXNBcnJheShjb21wYXRSZWNvcmQpXG4gICAgPyBjb21wYXRSZWNvcmQuZmluZCgoZSkgPT4gXCJ2ZXJzaW9uX2FkZGVkXCIgaW4gZSlcbiAgICA6IGNvbXBhdFJlY29yZDtcblxuICAvLyBJZiBhIHZlcnNpb24gaXMgdHJ1ZSB0aGVuIGl0IGlzIHN1cHBvcnRlZCBidXQgdmVyc2lvbiBpcyB1bnN1cmVcbiAgaWYgKHR5cGVvZiB2ZXJzaW9uQWRkZWQgPT09IFwiYm9vbGVhblwiKSByZXR1cm4gdmVyc2lvbkFkZGVkO1xuICBpZiAodmVyc2lvbkFkZGVkID09PSBudWxsKSByZXR1cm4gdHJ1ZTtcblxuICAvLyBTcGVjaWFsIGNhc2UgZm9yIFNhZmFyaSBUUDogVFAgaXMgYWx3YXlzIGd0ZSB0aGFuIGFueSBvdGhlciByZWxlYXNlc1xuICBpZiAodGFyZ2V0ID09PSBcInNhZmFyaVwiKSB7XG4gICAgaWYgKHZlcnNpb24gPT09IFwiVFBcIikgcmV0dXJuIHRydWU7XG4gICAgaWYgKHZlcnNpb25BZGRlZCA9PT0gXCJUUFwiKSByZXR1cm4gZmFsc2U7XG4gIH1cbiAgLy8gQSBicm93c2VyIHN1cHBvcnRzIGFuIEFQSSBpZiBpdHMgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWxcbiAgLy8gdG8gdGhlIGZpcnN0IHZlcnNpb24gb2YgdGhlIGJyb3dzZXIgdGhhdCBBUEkgd2FzIGFkZGVkIGluXG4gIGNvbnN0IHNlbXZlckN1cnJlbnQgPSBzZW12ZXIuY29lcmNlKGN1c3RvbUNvZXJjZSh2ZXJzaW9uKSk7XG4gIGNvbnN0IHNlbXZlckFkZGVkID0gc2VtdmVyLmNvZXJjZShjdXN0b21Db2VyY2UodmVyc2lvbkFkZGVkKSk7XG5cbiAgLy8gc2VtdmVyLmNvZXJjZSgpIG1pZ2h0IGJlIG51bGwgZm9yIG5vbi1zZW12ZXJzIChvdGhlciB0aGFuIFNhZmFyaSBUUClcbiAgLy8gSnVzdCB3YXJuIGFuZCB0cmVhdCBmZWF0dXJlcyBhcyBzdXBwb3J0ZWQgaGVyZSBmb3Igbm93IHRvIGF2b2lkIGxpbnQgZnJvbVxuICAvLyBjcmFzaGluZ1xuICBpZiAoIXNlbXZlckN1cnJlbnQpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgIGNvbnNvbGUud2FybihcbiAgICAgIGBlc2xpbnQtcGx1Z2luLWNvbXBhdDogQSBub24tc2VtdmVyIHRhcmdldCBcIiR7dGFyZ2V0fSAke3ZlcnNpb259XCIgbWF0Y2hlZCBmb3IgdGhlIGZlYXR1cmUgJHtub2RlLnByb3RvQ2hhaW5JZH0sIHNraXBwaW5nLiBZb3UncmUgd2VsY29tZSB0byBzdWJtaXQgdGhpcyBsb2cgdG8gaHR0cHM6Ly9naXRodWIuY29tL2FtaWxhamFjay9lc2xpbnQtcGx1Z2luLWNvbXBhdC9pc3N1ZXMgZm9yIGFuYWx5c2lzLmBcbiAgICApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGlmICghdmVyc2lvbkFkZGVkKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBgZXNsaW50LXBsdWdpbi1jb21wYXQ6IFRoZSBmZWF0dXJlICR7bm9kZS5wcm90b0NoYWluSWR9IGlzIHN1cHBvcnRlZCBzaW5jZSBhIG5vbi1zZW12ZXIgdGFyZ2V0IFwiJHt0YXJnZXR9ICR7dmVyc2lvbkFkZGVkfVwiLCBza2lwcGluZy4gWW91J3JlIHdlbGNvbWUgdG8gc3VibWl0IHRoaXMgbG9nIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWlsYWphY2svZXNsaW50LXBsdWdpbi1jb21wYXQvaXNzdWVzIGZvciBhbmFseXNpcy5gXG4gICAgKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gc2VtdmVyLmd0ZShzZW12ZXJDdXJyZW50LCBzZW12ZXJBZGRlZCk7XG59XG5cbi8qKlxuICogUmV0dXJuIGFuIGFycmF5IG9mIGFsbCB1bnN1cHBvcnRlZCB0YXJnZXRzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRVbnN1cHBvcnRlZFRhcmdldHMoXG4gIG5vZGU6IEFzdE1ldGFkYXRhQXBpV2l0aFRhcmdldHNSZXNvbHZlcixcbiAgdGFyZ2V0czogVGFyZ2V0W11cbik6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIHRhcmdldHNcbiAgICAuZmlsdGVyKCh0YXJnZXQpID0+ICFpc1N1cHBvcnRlZEJ5TUROKG5vZGUsIHRhcmdldCkpXG4gICAgLm1hcChmb3JtYXRUYXJnZXROYW1lcyk7XG59XG5cbmZ1bmN0aW9uIGdldE1ldGFkYXRhTmFtZShtZXRhZGF0YTogQXBpTWV0YWRhdGEpIHtcbiAgc3dpdGNoIChtZXRhZGF0YS5wcm90b0NoYWluLmxlbmd0aCkge1xuICAgIGNhc2UgMToge1xuICAgICAgcmV0dXJuIG1ldGFkYXRhLnByb3RvQ2hhaW5bMF07XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gYCR7bWV0YWRhdGEucHJvdG9DaGFpbi5qb2luKFwiLlwiKX0oKWA7XG4gIH1cbn1cblxuY29uc3QgTWRuUHJvdmlkZXI6IEFycmF5PEFzdE1ldGFkYXRhQXBpV2l0aFRhcmdldHNSZXNvbHZlcj4gPSBhcGlzXG4gIC8vIENyZWF0ZSBlbnRyaWVzIGZvciBlYWNoIGFzdCBub2RlIHR5cGVcbiAgLm1hcCgobWV0YWRhdGEpID0+XG4gICAgbWV0YWRhdGEuYXN0Tm9kZVR5cGVzLm1hcCgoYXN0Tm9kZVR5cGUpID0+ICh7XG4gICAgICAuLi5tZXRhZGF0YSxcbiAgICAgIG5hbWU6IGdldE1ldGFkYXRhTmFtZShtZXRhZGF0YSksXG4gICAgICBpZDogbWV0YWRhdGEucHJvdG9DaGFpbklkLFxuICAgICAgcHJvdG9DaGFpbklkOiBtZXRhZGF0YS5wcm90b0NoYWluSWQsXG4gICAgICBhc3ROb2RlVHlwZSxcbiAgICAgIG9iamVjdDogbWV0YWRhdGEucHJvdG9DaGFpblswXSxcbiAgICAgIC8vIEBUT0RPIEhhbmRsZSBjYXNlcyB3aGVyZSAncHJvdG90eXBlJyBpcyBpbiBwcm90b0NoYWluXG4gICAgICBwcm9wZXJ0eTogbWV0YWRhdGEucHJvdG9DaGFpblsxXSxcbiAgICB9KSlcbiAgKVxuICAvLyBGbGF0dGVuIHRoZSBhcnJheSBvZiBhcnJheXNcbiAgLmZsYXQoKVxuICAvLyBBZGQgcnVsZSBhbmQgdGFyZ2V0IHN1cHBvcnQgbG9naWMgZm9yIGVhY2ggZW50cnlcbiAgLm1hcCgocnVsZSkgPT4gKHtcbiAgICAuLi5ydWxlLFxuICAgIGdldFVuc3VwcG9ydGVkVGFyZ2V0cyxcbiAgfSkpO1xuXG5leHBvcnQgZGVmYXVsdCBNZG5Qcm92aWRlcjtcbiJdfQ==